---
title: "Automating antibiotic treatment choice using clinical prediction modelling: a microsimulation study"
format:
  docx:
    reference-doc: doc_template.docx
bibliography: UF_references.bib
csl: /Users/alexhoward/Zotero/styles/the-lancet-infectious-diseases.csl
editor: visual
---

Alex Howard\*\
\*corresponding author alexander.howard\@liverpool.ac.uk\
\*\*joint senior author

```{r, echo=FALSE,message=FALSE,warning=FALSE}

library(tidyverse)
library(knitr)
library(glue)

```

# Research in context

**Evidence before this study**

Clinical prediction modelling is a promising tool for predicting antimicrobial resistance and its outcomes. Implementing these models in clinical care, however, is hampered by the lack of a clinically informed method that quantifies the value (or utility) of antibiotic treatment to translate predictions into automated, personalised prescribing suggestions – a so-called utility function. 

**Added value of this study**

In this study, we develop an antibiotic decision-making algorithm for urinary tract infection (UTI) by constructing a utility function from prescriber-informed importance weights obtained using an innovative discrete choice experiment, probability predictions from statistical/machine learning models, prediction uncertainty metrics, and illness severity measures. We demonstrate that the decision algorithm can make treatment recommendations for UTI that preserve characteristics of treatment important to prescribers (e.g., oral route of administration), while maintaining patient safety by progressively broadening spectrum of coverage as patients become more systemically unwell.  

**Implications of all the available evidence**

The algorithm described in this study could help countries achieve meet WHO target of 70% Access category antibiotic prescribing by 2030 in a way that does not endanger agent efficacy in severely ill patients with sepsis. Further clinical research is required across a range of populations to better understand the impact of the algorithmic decision approach on individual and population outcomes.  

# Abstract

## Background

Antibiotic prescribing is a key driver of antimicrobial resistance. Automating antibiotic decisions using machine learning could help improve treatment precision by improving the accuracy of probability predictions and relieve time pressure on prescribers, but there is not currently a decision algorithm that can replicate human ability to weigh up the relative value of different treatment options. Here, we automated antibiotic choice decisions by developing and testing an individualised measure of treatment appropriateness – i.e., a utility function - that combines probability prediction of different treatment outcomes with measures of prediction confidence, illness severity, and the relative value of different antibiotic characteristics derived from real-world prescribers using an innovative mixed methods design. The aim of this approach was to maximise the projected benefits and practicality of antibiotic treatment for urinary tract infection (UTI) while minimising patient harm and the risk of antimicrobial resistance.  

## Methods

XGBoost clinical prediction models were trained, tested, tuned, and validated to predict the risk of antimicrobial resistance, *Clostridioides difficile* diarrhoea, and drug toxicity for 13 antibiotics in patients with culture-positive urine specimens using open-source real-world pseudonymised electronic healthcare records. Prescribers from a range of primary and secondary care settings undertook a discrete choice experiment ranking exercise with fictional antimicrobial agents – a ranked logit method was used to quantify the relative importance of different antimicrobial characteristics (e.g., oral bioavailability, toxicity, antimicrobial resistance risk) to prescribers. A utility function was written that combined these importance weights with probability predictions from the XGBoost models, prediction confidence (area under the receiver operating characteristic curve) and a hypothetical measure of illness severity to produce a utility value for each antibiotic for each patient. These utility values were then used to provide recommendations for urinary tract infection antimicrobial treatment in a microsimulation study design - the proportion of organisms grown in urine specimens that were susceptible to the recommended antibiotic, and the proportion of these recommendations that were WHO Access category antibiotics and had intravenous and oral routes of administration were measured across a range of hypothetical illness severities.

## Findings

Clinical prediction models were trained and validated on a dataset of 23,812 urine specimens and 86,682 antibiotic prescriptions. The microsimulation study was undertaken for 2,646 patients who had urine specimens sent. Area under the receiver operating curve for probability predictions ranged from 0.637 (95% CI 0.622-0.654) for ampicillin susceptibility to 0.888 (95% CI 0.868-0.898) for *C. difficile* diarrhoea. 49 prescribers participated in the discrete choice experiment from a range of primary and secondary care specialties - UTI-specificity of antibiotic agents most increased their probability of selection by prescribers, and high toxicity risk most reduced their probability of selection. At the lowest illness severity, nitrofurantoin had the highest utility (and was therefore recommended as individualised first-line therapy) in most patients. The first-line treatment recommendations at this illness severity were active in vitro against the organism subsequently grown in 81.25% of cases, and there was a median of five susceptible results per specimen for the top six automated recommendations (IQR 4-6), with a median of three susceptible Access results (IQR 2-4). As illness severity increased, treatment recommendations initially diversified into a mix of agents with varying WHO AWaRe categories and available routes of administration, before converging predominantly on piperacillin-tazobactam at the highest illness severity. Treatment recommendations at the highest illness severity score were active in vitro against the organism subsequently grown in 92.94% of cases.

## Interpretation

Our antibiotic decision algorithm, built on a prescriber-informed antimicrobial utility function could enable true AI-driven decision making in antimicrobial treatment and susceptibility testing. It could also help nations meet the United Nations target of 70% WHO Access agent prescribing without compromising on probability of treatment efficacy. The innovative prescriber-informed approach used is flexible enough to be adaptable to a range of healthcare settings by allowing local clinician factors such as cost and patient cohort to influence the weights of different factors, as well as local epidemiology of resistance, toxicity, C difficile, and illness severity. Strengthening the prediction model by incorporating more healthcare data from local settings is likely to further improve performance. Clinical trials of the algorithm are required to determine the real-world impact of the approach on individuals and populations.

## Funding

This research was funded in part by the Wellcome Trust grant ref: 226691/Z/22/Z. For the purpose of open access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript version arising from this submission. Office for Life Sciences Data-Action Accelerator award also supported this work. The funders had no role in the conceptualisation, design, data collection, analysis, decision to publish or preparation of the manuscript.

# Introduction

Functioning antibiotics underpin all healthcare systems – antimicrobial resistance (AMR) is therefore a significant threat to the delivery of global healthcare.[@walshAntimicrobialResistanceAddressing2023] In September 2024, the United Nations General Assembly (UNGA) committed to ensuring that the safest, cheapest antibiotics with the lowest AMR risk (World Health Organisation \[WHO\] Access Category antibiotics) make up 70% of global antibiotic use in healthcare by 2030.[@un2024_amr] The challenge in achieving this goal is determining when it is safe to empirically use Access agents, which often have a relatively narrow spectrum of activity and will therefore be avoided in favour of more harmful Watch category agents to ensure treatment efficacy where there is doubt about the presence of resistance and/or perceived high stakes (e.g., systemically unwell patients). [@howardPersonalisedAntimicrobialSusceptibility2024, @rheeTrendsEmpiricBroadSpectrum2024]

Algorithmic support of antimicrobial treatment choice is a potential means to deliver optimally precise antimicrobial therapy - this approach can quantify the probability of resistance and treatment outcomes using clinical prediction models with drug, patient, and pathogen characteristics.[@corbinPersonalizedAntibiogramsMachine2022] Algorithms, however, cannot judge the subjective value (or cost) of treatment outcomes to patients, populations, and healthcare systems.[@staderAlgorithmsDontHave2024] To best support antibiotic treatment decisions, algorithms need to be able to quantify the value of antibiotic treatment - a mathematical utility function is a way to do this.[@walshUtilityFunctionsAutonomic2004] Antibiotic treatment suggestions using a utility function might give prescribers the confidence to use Access category antibiotics when it is safe to do so, while compromising on Access antibiotic use in situations where treatment efficacy needs to be prioritised (e.g., where risk of resistance and/or clinical deterioration from untreated infection is high). 

Here, we describe a urinary tract infection (UTI) treatment choice automation algorithm built on a utility function that combines clinical prediction models with prediction confidence, prescriber-informed outcome values/costs, and illness severity. The aim of this study was to assess the potential of this decision support tool to help meet the UNGA 70% global Access antibiotic target without compromising individual patient safety. 

# Methods

## Ethics

The study complied with the PhysioNet MIMIC-IV dataset Data Use Agreement 1.5.0 and Health Data License. Approval was also obtained for the discrete choice experiment from the NHS Health Research Authority (HRA). A proportionate review was undertaken by a UK Research Ethics Committee (REC), which determined that full REC approval was not required.

## Utility function design

The utility function is a mathematical calculation (see Appendix 2) that was performed by the algorithm for each individual patient that had a urine specimen sent in the real-world MIMIC-IV dataset (see 'Data Sources' section below). The function outputs a numerical utility value for each antibiotic for each individual patient - this number represents the value of each antibiotic to that patient as a potential treatment. This utility value is arrived at by weighting antibiotic characteristics and predicted treatment outcomes by their importance to prescribers.

The utility function also has an in-built safety mechanism that weights antibiotic susceptibility probability and intravenous administration more heavily as illness severity increases (reflecting the fact that antibiotic efficacy and the availability of intravenous routes of administration are more important in patients with sepsis).[@buckmanEmpiricAntibioticsSepsis2018]

The utility function requires four inputs (Figure 1), chosen to mimic expert intuition-based decision making [@zhurisk2021]:

1. Antibiotic characteristics - individualised to each patient, and consisting of either known characteristics of the antibiotic (e.g., cost, WHO AWaRe category) or predicted outcomes of antibiotic therapy (antimicrobial susceptibility, CDI, and toxicity).

2. Characteristic weights - the relative importance of each antibiotic characteristic to expert prescribers, obtained from the discrete choice experiment.

3. Outcome certainty - the level of confidence in antibiotic outcome predictions.

4. Illness severity - a surrogate marker of the potential consequences of antibiotic failure.\

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/Utility function design.pdf")

```

Figure 1: Design of the utility function. A human approach to antibiotic decision making was approximated by combining probability predictions with prediction confidence, the relative value of different treatment characteristics, and the consequences of treatment failure (represented by illness severity).\

## Antibiotic characteristic inputs

Known antibiotic characteristics (e.g., WHO Access category) were denoted by a 1 if present and a 0 if absent. Antibiotic financial cost was determined using the lowest procurement/tender award price for each agent in U.S. dollars as listed on the U.S. Department of Veterans Affairs National Acquisition Center (<https://www.vendorportal.ecms.va.gov/NAC/>) when accessed in November 2024 - these values were divided by the highest cost including combinations of antibiotics to produce normalised numbers between zero and one.[@supportVANationalAcquisition]

Antibiotic characteristics that relate to outcomes are uncertain, and therefore require probability predictions to be made. Clinical prediction models were used to provide the probability prediction inputs for antibiotic outcomes in the utility function. Clinical prediction model training/testing/validation was performed using the open-source PhysioNet dataset MIMIC (Medical Information Mart for Intensive Care)-IV version 2.2, a pseudonymised inpatient and outpatient electronic healthcare record dataset for patients over the age of 18 who were admitted to intensive care or the emergency department between 2008 and 2019 at Beth Israel Deaconess Medical Center (BIDMC - Boston, MA) (<https://physionet.org/content/mimiciv/2.2/>).[@johnsonMIMICIVClinicalDatabase, @johnsonMIMICIVFreelyAccessible2023b, @goldbergerPhysioBankPhysioToolkitPhysioNet2000b] Specific data sources within MIMIC-IV are listed in Appendix 3. Antimicrobial susceptibility interpretations are likely to be based on Clinical Laboratory Standards Institute clinical breakpoints given the U.S. setting.[@patelUpdatingBreakpointsUnited2023] Sample size was determined by the size of the available dataset, and provided a sufficient number of cases per independent variable in the model to reduce the probability of overfitting.[@bramerAvoidingOverfittingDecision2007]

The full data preprocessing workflow is summarised in Appendix 3, and the full model specification and training/tuning process is summarised in Appendix 4. Data preprocessing and quality checking was performed in a similar way across sociodemographic groups using RStudio version 2023.12.1+402, and followed a similar pattern to our previous work with the dataset with some additions.[@howardPersonalisedAntimicrobialSusceptibility2024, @rstudioref] After data preprocessing, urine culture susceptibility data were available for 13 antibiotics (ampicillin, ampicillin-sulbactam, piperacillin-tazobactam, cefazolin, ceftriaxone, cefepime, meropenem, ciprofloxacin, gentamicin, trimethoprim-sulfamethoxazole, nitrofurantoin, and vancomycin).

A total of 15 individual models were required for the main analysis - 13 individual antibiotic susceptibility prediction models for each antibiotic in the urines dataset, a *Clostridioides difficile* infection (CDI) prediction model on the prescriptions dataset, and an antibiotic toxicity prediction model on the prescriptions dataset. The same XGBoost technique was used for all 15 models.[@chenXgboostExtremeGradient2014, @chenXGBoostScalableTree2016] The output of each model was the probability of the binary outcome's positive class (an 'S' result, CDI, or antibiotic toxicity). A sensitivity analysis was performed where 24 additional susceptibility prediction models were trained and validated for 2-antibiotic combinations that were used at least 500 times in the prescriptions dataset.

A single validation run was then performed with the final trained model on the validation dataset, measuring AUROC, accuracy, precision, recall, and F1 score (decision threshold 0.5) using coded formulae for each model. 95% confidence intervals were approximated for each metric using a bootstrap method with 1000 iterations.

## Characteristic importance inputs

The discrete choice experiment provided the antibiotic characteristic relative importance value inputs for the utility function. The discrete choice experiment survey was completed online between June 1st 2024 and October 31st 2024 by UK-based antibiotic prescribers from general practice (GP), medicine, surgery, intensive care, and infectious diseases/medical microbiology. Sample size was determined by the number of respondents in the 4-month survey period. No minimum sample size was stipulated, but the aim was to obtain at least some participants from each specialty.

A questionnaire (see Appendix 1) posed 13 fictional antibiotics with six characteristics (AWaRe class, CDI risk, toxicity, UTI-specificity, oral and IV administration) - these numbers of fictional antibiotics and characteristics were chosen as a balance between the time taken for respondents to complete the task and providing sufficient variance in characteristics to minimise collinearity.[@buddAdaptationWHOEssential2019] Participants were given a fictional UTI clinical scenario, then asked to rank the treatments in order of suitability.

A ranked logit approach (Appendix 3) was used to develop a model based on the ranking of each antibiotic (1-13) by participants was used to produce coefficients for each characteristic that represented the relative weight of each antimicrobial characteristic to the expert participants in making an antimicrobial treatment choice for UTI. Coefficients were analysed using data visualisation by bar plot, with 95% confidence intervals approximated using a bootstrap method with 1000 iterations. A sensitivity analysis was performed where the approach was repeated on subsets of the data to build separate models for infection specialties, medicine, surgery, intensive care, and general practice to compare the weights of the six antimicrobial characteristics to different specialties.

## Outcome certainty and illness severity inputs

The outcome certainty input was quantified using predictive performance of the clinical prediction models, obtained as area under the receiver operating characteristic (AUROC) values from the model validation process. Illness severity measures were not reliably available in the MIMIC-IV dataset, and such measures vary geographically - this input was therefore approached as a sensitivity analysis, where utility was calculated for each patient across a range of potential illness severities in the microsimulation study.

## Microsimulation study

An individual-level simulation (microsimulation) study design was used to assess distributions of antibiotic utility values and projected outcomes of the decision algorithm in real-world data.[@DynamicMicrosimulationModels] The distributions of utility values at an illness severity value of zero were plotted across the microsimulation dataset for each antibiotic and antibiotic combination using a box and whisker plot. Sensitivity analyses where the utility distribution was repeatedly calculated on the microsimulation dataset across a range of zero to one for susceptibility probability, CDI probability, toxicity probability and normalised cost, and a range of minus two to two for characteristic weights (at an illness severity value of one so that intravenous treatment utility was not flat across all values) - changes in overall utility distribution in the microsimulation dataset across these ranges were then plotted for all antibiotics using line plots.

The single antibiotic with the highest utility value for each patient in the microsimulation dataset was selected as the personalised first-line treatment recommendation for that patient. The antibiotic with the second-highest utility was chosen as second-line option, and so on until all 13 antimicrobial agents were ranked as treatment recommendations in order of utility value for each patient. Sensitivity analyses were performed to assess the effect of increasing the illness severity weight on the proportion of subsequent isolates that were covered by recommendations (all, Access-category, oral routes of administration, intravenous routes of administration). These results were visualised. Illness severity values were hypothetical (reliable contemporaneous measures of illness severity were not available in the dataset) and ranged from zero up to the number at which the proportion of subsequent isolates that were covered by all recommendations visibly plateaued. Proportions were compared visually against a standard first-line option for systemically well patients (nitrofurantoin) and for critically ill patients (piperacillin-tazobactam) – these agents were selected as comparators because they were the oral and intravenous antibiotics respectively that had the highest rates of susceptibility in the dataset. The median and interquartile range of the number of susceptible results in the top six recommendations was also measured and compared to a standard top six of nitrofurantoin, trimethoprim/sulfamethoxazole, gentamicin, piperacillin/tazobactam, ceftriaxone, and ciprofloxacin (based on a combination and WHO and European Society of Urology UTI treatment guidelines, and as described for directing antimicrobial susceptibility testing in our previous work.[@howardPersonalisedAntimicrobialSusceptibility2024, @EAUGuidelinesUrologicala, @WHOAWaReAccess]

The illness severity sensitivity analysis was then repeated firstly to examine second-line treatment recommendations (antibiotics with the second-highest treatment utility), then secondly with antimicrobial combinations also included as treatment options, then thirdly to assess the potential effect of improved probability predictions for single-agent recommendations (the latter by taking the mean of the predicted probability and the actual outcome denoted by one or zero) – outcomes and antibiotics recommended were again plotted across illness severity using area and line charts respectively. The analysis was repeated to assess the effect of increased illness severity on the predicted CDI risk, toxicity risk, and minimum financial cost of first-line treatment recommendations. A similar sensitivity analysis was performed to assess the effect of increasing nitrofurantoin resistance probability from zero up to one on the four outcomes listed above and antibiotics recommenced, plotting the results using an area and line chart respectively.

An ‘edge case’ sensitivity analysis was performed to test extreme parameters arising from the discrete choice experiment by simulating 1,000 survey responses with identical rankings in which oral routes of administration were all ranked as high as possible and high cost options all ranked as low as possible – utility values were then for single agents and plotting the ranked logit coefficients, utility values, and illness severity sensitivity analysis as described above.

# Results

## Participants

The characteristics of patients, antimicrobial agents, and specimens in the model development and microsimulation datasets are summarised in Appendix 5. The proportion of all patient/specimen characteristics between the urine model development dataset and microsimulation dataset were comparable. A higher proportion of specimens in both urine datasets came from females than males, while the number of prescriptions for all indications in the prescription dataset was approximately equal between males and females. 60-69 was the most prevalent age group in the prescription dataset, while 70-79 was the most prevalent age group in both urine datasets. A higher proportion of patients in the prescription dataset had English recorded as spoken language than in either urine dataset – this likely reflects the inpatient provenance of the prescription dataset, with more detailed observation of patients, while the urine dataset included both inpatients and outpatients. The numbers of different antibiotic types prescribed in the prescription dataset are summarised in Appendix 6.

## Clinical prediction model specification and performance

Final training hyperparameters used for each model are summarised in Appendix 7, and predictor variable contributions to predictive performance are summarised in Appendix 8. The presence and/or absence of previously-detected resistance to an antibiotic in the last year was one of the largest contributors to predictive accuracy for susceptibility to that antibiotic in most models. Gender and age group were large contributors to antibiotic susceptibility predictive performance in all models. Hospital admission in the last year, age over 65, previous CDI, and previous acute kidney injury in the last year were among the largest contributors to predictive performance for both CDI and antibiotic toxicity.

Receiver operating characteristics (ROC) curves and performance metrics for models predicting single-antibiotic susceptibility, *C. difficile* infection (CDI), and toxicity in the single validation run on the validation dataset are summarised in Figure 2 and Table 1 respectively. ROC curves and performance metrics for models predicting susceptibility to 2-antibiotic combinations are summarised in Appendix 9 and Appendix 10 respectively.

```{r, echo=FALSE,message=FALSE,warning=FALSE}

knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/roc_plots_main.pdf")
  
```

Figure 2: ROC curves for probability predictions made for single-antibiotic susceptibility, *C. difficile* infection (CDI), and toxicity on the validation dataset.\

```{r, echo=FALSE,message=FALSE,warning=FALSE}

metrics_singles_table <- read_csv("/Users/alexhoward/Documents/Projects/UDAST_code/metrics_singles_table.csv")

knitr::kable(metrics_singles_table)

```

Table 1: Model performance metrics for prediction of single-antibiotic susceptibility, CDI, and antibiotic toxicity in the single validation run on the validation dataset. 95% confidence intervals are displayed in parentheses.\

Performance metrics from the small training dataset stability analysis are summarised in Appendix 11. The largest difference in mean AUROC across six model train-test iterations was observed between the 2% and 12% training datasets in the CDI prediction model (0.132, 0.631 versus 0.763), and the largest AUROC standard deviation was observed in the 2% dataset in the CDI prediction model (0.025). Performance metrics from the year group cluster analyses are summarised in Appendix 12. For all models and all year groups, mean AUROC across six train-test iterations was highest in the same year group upon which the model had been trained. The largest difference in AUROC between year groups was observed for the toxicity prediction model between 2011-2013 training, 2011-2013 testing and 2011-2013 training, 2014-2016 testing (0.257, 0.880 versus 0.623). The largest AUROC standard deviation was observed for the CDI model with 2008-2010 training, 2011-2013 testing (0.091).

Performance metrics from the model fairness analyses are summarised in Appendix 13. The largest difference in mean AUROC across six model train-test iterations in the age fairness analysis was observed between the 40-49 and 80-89 age groups for piperacillin-tazobactam susceptibility prediction (0.136, 0.831 versus 0.695), and the largest AUROC standard deviation was observed for CDI prediction in the over 90s age group (0.077). The largest difference in mean AUROC across six model training iterations in the race fairness analysis was observed between Hispanic patients and the aggregate group containing the least prevalent local races (i.e., not Asian, black, or white) for ciprofloxacin prediction (0.093, 0.738 versus 0.646), and the largest AUROC standard deviation was observed in Asian patients for CDI prediction (0.078). The largest difference in mean AUROC across six model training iterations in the remaining characteristics was observed between females and males - this difference was most marked in susceptibility prediction models for cephalosporins, meropenem, and gentamicin, with the largest difference in mean AUROC observed for meropenem (0.102, 0.727 versus 0.625), and the largest AUROC standard deviation observed in piperacillin-tazobactam susceptibility prediction for males (0.023).

## Discrete choice experiment

49 prescribers participated in the discrete choice experiment (15 from infection specialties, 11 from other medical specialties, nine from surgical specialties, nine from intensive care, and five from general practice). The coefficients from the ranked logit analysis of the discrete choice experiment across all specialties are displayed in Figure 3, and the coefficients by individual specialty are displayed in Appendix 14. Overall, an antibiotic being specific to urinary tract infection in its licensed indication appeared to have the most positive effect on its probability of selection in the discrete choice experiment, and high toxicity risk the greatest negative effect on its probability of selection. High antibiotic cost appeared to have the least effect on probability of antibiotic selection, exhibiting a minimal positive effect with the approximated 95% confidence interval crossing the line of no effect.

```{r, echo=FALSE,message=FALSE,warning=FALSE}

knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/ORplot.pdf")

```

Figure 3: Coefficients from the ranked logit analysis of the discrete choice experiment across all prescriber specialties.\

General practitioners and infection specialists were more likely to select antibiotics with oral routes of administration, and less likely to select antibiotics with intravenous routes of administration - the opposite was observed in intensive care and medical specialty prescribers, where intravenous routes of administration were preferred over oral routes. Routes of administration appeared to have less bearing on choice in surgical specialties than in other specialties. In medical specialties and intensive care, an antibiotic being in the WHO Access category most increased the probability of selection. Intensive care was the only specialty in which an antibiotic being in the WHO Reserve category reduced the probability of selection more than high toxicity risk. Wide confidence intervals for coefficients estimated from general practitioners reflected the low numbers of respondents from that prescriber group (n=5).

## Utility function

The distributions of single-antimicrobial choice utility values for patients across the microsimulation dataset are displayed in Figure 4, The distributions of single-agent utility values stratified by prescriber types are displayed in Appendix 15, and the distribution of all antibiotic options including 2-agent combinations are displayed in Appendix 16.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/utility_Treatment_ (single agent).pdf")
```

Figure 4: Distributions of antimicrobial choice utility values for patients across the microsimulation dataset.\

At the lowest illness severity, nitrofurantoin had the highest median treatment choice utility in the microsimulation dataset. For single-agent treatment, five of the six antibiotics with the highest median utility were WHO Access agents - the only exception to this was piperacillin-tazobactam, which placed fourth overall amongst single agents. The lowest placed WHO Access antibiotic was ampicillin (or amoxicillin), which placed 12th out of 13 agents. Vancomycin was the lowest-placed antibiotic choice for most patients in terms of median utility across the population. The widest spread in utility values was observed for cefazolin (IQR 1.57), reflecting the fact that predicted probability of susceptibility to cefazolin varied the most across the population (IQR 0.28).

Nitrofurantoin was the highest-placed agent for all prescriber specialties in terms of median utility across the population, and the placement of other agents was more variable. The largest differences observed between antibiotic utility values were between general practice and intensive care – agents with oral routes of administration ranked higher in the former, while those with intravenous routes of administration ranked higher in the latter. When two-agent combinations were included in the general analysis, ampicillin plus gentamicin became the second-placed treatment option in terms of median utility across the population (behind nitrofurantoin), meropenem plus vancomycin the third, and piperacillin-tazobactam plus ciprofloxacin the fourth.

The sensitivity analyses that examined the effect of varying different utility function parameters on overall treatment choice utility are displayed in Appendix 17. The largest factor in the sensitivity of antibiotic utility to parameter changes within the utility function was probability of susceptibility, reflecting the fact that they were being multiplied this value in the utility function – the steepest corresponding increases/decreases in utility when most parameters were varied were therefore observed for piperacillin-tazobactam because it had the highest median predicted probability of susceptibility (0.899). When probability of susceptibility or susceptibility prediction AUROC were varied, the combined value of all other parameters in the utility function became more important - nitrofurantoin therefore exhibited the steepest corresponding increases/decreases in utility in response to changes in susceptibility prediction AUROC. There was little variation in utility function sensitivity between antibiotics when CDI importance weight was varied, reflecting low median predicted probabilities of CDI in the dataset (all values for single agents falling between 0.002 for meropenem and 0.001 for cefazolin). There was more variation in utility between antibiotics when toxicity importance was varied, reflecting a wider variation in toxicity probability (all values for single agents falling between 0.190 for meropenem and 0.071 for nitrofurantoin). Varying AUROC values for CDI and toxicity prediction had little effect on overall utility values.

## Microsimulation

The results of the illness severity microsimulation study are displayed in Figures 5 and 6.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of WHO Access agents)_susplot.pdf")
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of orally-administrable agents)_susplot.pdf")
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of IV-administrable agents)_susplot.pdf")
```

Figure 5: The proportion of organisms subsequently grown in urines that were covered by the automated first-line antibiotic treatment recommendation depending on illness severity, with the proportion of Access category agents (top), agents with oral routes of administration (middle), and agents with intravenous routes of administration (bottom) providing coverage also indicated.\

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/illness_abplot.pdf")

```

Figure 6: The make-up of automated first-line treatment recommendations by antibiotic agent depending on illness severity.\

At the lowest illness severity, nitrofurantoin was the first-line treatment recommendation in almost all cases, covering 81.25% of organisms subsequently grown. There were a median of five susceptible results per specimen for the top six automated recommendations (IQR 4-6), with a median of three susceptible Access results (IQR 2-4, see Appendix 18). As population illness severity was increased, the proportion of organisms covered and the provision of an IV treatment option increased accordingly, both reaching a plateau at 92.94% for the most unwell patients. Likelihood of coverage for a patient population with severe illness was achieved by the algorithm at the expense of recommending Access treatment options and oral treatment options (which fell to 1.25% and 1.75% respectively for the most unwell patients) - this was largely driven by a switch of automated recommendations to piperacillin-tazobactam as population illness severity was increased. At intermediate levels of illness severity, the proportion of Access agent recommendations was maintained by the algorithm by increasing recommendations for cefazolin or gentamicin.

The proportion of organisms covered by second-line automated recommendations (Appendix 19) initially increased with illness severity due to nitrofurantoin falling to second-line option, but as intravenous treatment was prioritised, the proportion of coverage fell back to 80.2%. The proportion of Access category agents with coverage was preserved at 30.2% at high illness severity owing to higher proportions of gentamicin recommendations for second-line treatment than for first-line treatment

When combinations of antimicrobial agents were included (Appendix 20), automated treatment recommendations were able to cover a higher proportion of the most unwell population (98.5%) by recommending either meropenem and vancomycin, piperacillin-tazobactam and ciprofloxacin, or piperacillin-tazobactam and trimethoprim-sulfamethoxazole. At intermediate levels of illness severity, the proportion of Access agent recommendations was maintained by the algorithm by increasing recommendations for ampicillin and gentamicin.

Artificially improving the accuracy of probability predictions (Appendix 21) increased the proportion of organisms covered by first-line treatment recommendations for all levels of illness severity (98.8%), preserving 28.3% Access and 30% oral antibiotic recommendations even at the highest levels of illness severity while increasing the number of recommendations with IV preparations to 98.7%.

Median predicted CDI probability from automated recommendations remained low as illness severity increased. Median predicted antibiotic toxicity probability from automated recommendations increased from 0.072 to 0.164 as illness severity increased. Median minimum U.S. drug cost increased from \$18.80 to \$22.10 as illness severity increased.

Increasing median nitrofurantoin predicted resistance probability (Appendix 22) reduced the proportion of first-line automated recommendation organism coverage to a nadir of 65.5% at a median resistance probability of 43.3%. As nitrofurantoin resistance predictions rose above 50%, the coverage proportion rose to 78.9% as the algorithm selected more gentamicin, ampicillin/sulbactam, and cefazolin as first-line therapy instead of nitrofurantoin.

The discrete choice experiment edge case sensitivity analysis (Appendix 23) resulted in the appropriate prioritisation of oral antibiotics and avoidance of more expensive antibiotics, with ciprofloxacin exhibiting the highest median utility value. An unanticipated effect was a strongly negative ranked logit coefficient for UTI-specificity, resulting in a low median utility value for nitrofurantoin. To address suspected collinearity as a cause for this phenomenon, UTI-specificity was remove from one antibiotic option with an oral route of administration and added to an antibiotic without an oral route of adminstration – this action resolved the effect and resulted in a positive coefficient value for UTI-specificity (Appendix 24).\

# Discussion

This study shows that antibiotic decision making for individual patients can be made more empirical and systematic by using an algorithmic utility function built on clinical prediction modelling, prescriber discrete choice experiments, and measures of illness severity. This automation could help safely maximise the use of WHO Access category antibiotics in clinical practice while minimising the risk of clinical failure due to resistance. Where illness severity is very low or very high, our algorithm behaves much like a fixed antimicrobial formulary, where patients with uncomplicated lower UTI are recommended nitrofurantoin and patients with urosepsis are recommended piperacillin-tazobactam. However, the algorithm is able to provide more nuance than an antimicrobial formulary in the area in between these two extremes. As illness severity increases, our algorithm progressively compromises on the use of Access agents to reduce the probability of clinical failure and prioritise agents that can be administered intravenously.

Our algorithm can safely navigate antibiotic decision making for three reasons: firstly, clinical prediction modelling is likely to provide more objective estimates of the probability of antibiotic outcomes than clinicians who can be vulnerable to psychological phenomena such as the availability heuristic (where the gravity of events influences perception of their probability); secondly, the algorithm leverages the experience of real-world prescribers by quantifying how important they perceive different factors to be in a theoretical scenario where they can be more objective; and thirdly, the utility function is constructed to weight intravenous antibiotics and probability of susceptibility more heavily as patients become more unwell, allowing the algorithm to replicate a key aspect of clinical judgement in antibiotic prescribing – weighing the risks of untreated infection vs antibiotic-related harms and AMR generation.

We envisage the algorithm result being presented to the clinician at the point of ordering a urine culture test. The utility of different antibiotic options can be calculated using probability predictions based on the patient’s prior healthcare data, importance weights from a local discrete choice experiment, and a locally relevant illness severity score (e.g., National Early Warning Score \[NEWS\] in the UK). The top three antibiotics can then be communicated to the clinician through the test ordering interface as first, second, and third-line recommendations, and the top six antibiotics are chosen for susceptibility testing. For this to be done safely, local calibration of the utility function to the chosen illness severity score will need to be performed with input from expert prescriber stakeholders by tweaking the built-in severity weight and gauging its effect with the sensitivity analysis displayed in Figure 5 – this will ensure that coverage rates are acceptable to local users of the algorithm (e.g., a coverage of at least 90% may be desired once a patient’s NEWS is 5 or above). The algorithm could also be easily adapted to account for known antibiotic allergies and other contraindications when making prescribing recommendations – this is not done in this study because reliable allergy information is not available in the dataset.

Subsetting the discrete choice experiment by specialty highlights that the utility function can and should be adapted for the setting in which it will be used to direct automated prescribing decisions. The experiment reveals, for example, that intensive care physicians have different needs and priorities to general practitioners when presented with the UTI clinical scenario. Cost is not a high priority for any prescribers in this study, but in low and middle income countries (LMICs) this may be given a much higher weight by local prescribers in the discrete choice experiment, and therefore in the automated prescribing decisions it informs. A lack of digital infrastructure in LMICs may provide a barrier to the implementation of personalised algorithmic prescribing decisions, but the utility function approach may also be useful for population-level and policy-level decisions (e.g. informing LMIC formularies or directing antibiotic supply chains).

The microsimulation approach in this study helps gauge the performance of the algorithm in a more meaningful way than metrics such as AUROC alone. The fact that the decision algorithm is unable to provide a higher probability of organism coverage for very unwell patients than piperacillin-tazobactam (the antibiotic in the study with the highest probability of coverage of organisms grown) shows that the algorithm’s susceptibility probability predictions are not able to detect rare resistance with sufficient sensitivity to provide additional benefit over a ‘one-size-fits-all’ approach in the most unwell patients. When probability predictions are artificially improved, the performance of the algorithm also improves in recommending an antibiotic that is more likely to cover the organism grown from patients at all levels of illness severity.

Another benefit of improving predictions could be greater fairness. Our fairness analysis shows that AUROCs are lower for males when predicting susceptibility to several antibiotics. Because a classification approach is not used here, methods to resolve this such as decision threshold modification are not possible – our algorithm instead weights probability predictions by their AUROCs so that agents with higher prediction probability confidence are prioritised. The most effective way to improve fairness, however, would be more data collection from under-represented groups – predictions are likely to be poorer in males because UTI is less common in that cohort, so they are less well-represented in the training dataset. More data collection may also help to improve performance in different and time periods and geographical cohorts – probability predictions in this study are worse when models are trained on one time period and tested on another, reflecting how AMR constantly changes over time.

The algorithm adapts to different resistance rates. When nitrofurantoin resistance probabilities are increased in the sensitivity analysis, the algorithm initially continues to select nitrofurantoin first-line due to the expressed priorities of prescribers in the discrete choice experiment (UTI-specificity, oral administration, and Access category), despite falling probability of organism coverage. The algorithm reaches a tipping point once nitrofurantoin resistance probability hits a particular threshold, other antibiotics are selected first-line, and probability of coverage rises again. This phenomenon demonstrates that despite the utility function being a linear mathematical expression, the effects of changing real-world circumstances on decisions (and therefore potentially patient outcomes) are not necessarily linear. Another example of this is second-line treatment recommendations, where the probability of coverage rises and falls with increasing illness severity as nitrofurantoin temporarily becomes the second-line agent as it falls down the utility rankings.

An assumption made in the main analyses of this study is that a single antibiotic is preferable as empirical treatment. It is possible, however, that as AMR increases globally, combination regimens may become increasingly desirable and/or necessary – this is already reflected in some treatment guidelines, particularly where allergies and other drug contraindications make achieving adequate empirical coverage with a single antibiotic difficult. In this study, the decision algorithm is able to achieve higher rates of coverage than universal piperacillin-tazobactam treatment once combinations of agents are included. Predicting outcomes from antibiotic combinations using retrospective real-world data is challenging, due to its relative rarity in many settings - the benefit of using an adaptive approach with up-to-date real-world data, however, is that algorithmic decisions should further improve if combination therapy becomes more common.

When confronted with an extreme scenario (an ‘edge case’) where 1,000 sets of discrete choice experiment rankings were identical and all favoured oral administration options, the utility function responds appropriately by prioritising oral antibiotics at the expense of all other considerations but unexpectedly deprioritises UTI-specificity. The probable reason for this phenomenon is that all options in the discrete choice experiment that were UTI-specific also had oral options, resulting in strong collinearity in the model. When this collinearity was reduced by retrospectively changing the characteristics of two antibiotic options, the UTI-specificity coefficient was more as expected. In future work, an expanded panel of antibiotic options should be considered to enable more variation in characteristics to reduce collinearity – however, a strength of our survey was its brevity, so any expansion should be balanced against the effect of time taken to complete the survey on anticipated response rates.

Our study has several limitations: firstly, the urine dataset is limited to secondary care patients and the prescription dataset to inpatients only. Given that the benefits of the algorithm are likely to be highest in primary care where most antibiotic prescribing occurs, the approach needs to be validated in this setting. Secondly, although the microsimulation approach can indicate how recommendations would have covered organisms grown here, it cannot determine whether recommendations would have been followed, or examine potential outcomes in instances of UTI where organisms are not grown. The algorithm therefore needs to be validated in a clinical study with appropriate outcomes that incorporate health economic analyses to best ascertain overall patient and population impact. Thirdly, the number of respondents to the discrete choice experiment is the lowest in the general practitioner group, which may reflect that this cohort are among the busiest and therefore do not have time to undertake a survey. Paradoxically, it is these specialty cohorts in which a decision support algorithm may have the most benefit, so further work is required to understand how best to engage busy clinicians in qualitative-quantitative study approaches.

Despite these limitations, this study demonstrates how an innovative algorithmic decision approach that constructs a utility function from quantification of the key considerations for antimicrobial prescribing decisions (namely probability of different outcomes, the importance of different outcomes, and the consequences of inaccurate predictions) could help countries achieve the WHO target of 70% Access category antibiotic prescribing by 2030 in a way that does not endanger clinical efficacy where it matters most - in severely ill patients at high risk of deterioration from sepsis. Further research is required in a clinical study across multiple geographical areas to better understand the impact of our automated decision algorithm on individual and population outcomes.

# References

::: {#refs}
:::

## Funding

This research was funded in part by the Wellcome Trust grant ref: 226691/Z/22/Z. For the purpose of open access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript version arising from this submission. Office for Life Sciences Data-Action Accelerator award also supported this work. The funders had no role in the conceptualisation, design, data collection, analysis, decision to publish or preparation of the manuscript.

## Conflicts of interest

Alex Howard declares personal consulting work for Pfizer outside the submitted work, and a donation from Pfizer to the University of Liverpool for a public and professional engagement project outside the submitted work.

## Data sharing

The MIMIC-IV version 2.2 data set is publicly accessible as a credentialed PhysioNet user at https://physionet.org/content/mimiciv/2.2/ once mandated training is completed, and the data use agreement is signed. Additional aggregate-level data can be provided by the authors if requests to do so are in line with legal and ethical data use regulations. Open-source code written for this study will be made available upon publication.

## Code sharing

Open-source code to reproduce the study using the above dataset is available at <https://github.com/amh312/Antimicrobial_utility>.

## Contributions

AH conceived the study, performed data engineering and mathematical modelling, and wrote the manuscript including diagrams.

## Acknowledgements

**Permissions from survey participants required**
