---
title: "Automating antibiotic treatment choice using clinical prediction modelling: a microsimulation study"
format:
  docx:
    reference-doc: doc_template.docx
bibliography: UF_references.bib
csl: /Users/alexhoward/Zotero/styles/the-lancet-infectious-diseases.csl
editor: visual
---

Alex Howard\*\
\*corresponding author alexander.howard\@liverpool.ac.uk\
\*\*joint senior author

```{r, echo=FALSE,message=FALSE,warning=FALSE}

library(tidyverse)
library(knitr)
library(glue)

```

# Research in context

**Evidence before this study**

Clinical prediction modelling has been shown to be a promising tool in predicting antimicrobial resistance and its outcomes, but the implementation of these tools as decision support in clinical care is hampered by the lack of a clinically-informed utility (or value) function to convert predictions into automated, personalised prescribing decisions.

**Added value of this study**

In this study, we develop an antibiotic decision making algorithm for UTI by constructing a utility function from prescriber-informed importance weights obtained using an innovative discrete choice experiment design, probability predictions from the machine learning models, prediction confidence measures, and illness severity measures. we demonstrate that the decision algorithm can make treatment recommendations for UTI that preserve characteristics of treatment important to prescribers (e.g., oral route of administration), while maintaining patient safety by progressively broadening spectrum of coverage as patients become more systemically unwell.

**Implications of all the available evidence**

The decision algorithm described in this study could help countries achieve meet WHO target of 70% Access category antibiotic prescribing by 2030 in a way that does not endanger agent efficacy in severely ill patients with sepsis. Further research is required in a clinical trial setting across a range of populations to better understand the impact of the algorithmic decision approach on individual and population outcomes.

# Abstract

## Background

Antibiotic prescribing is a key driver of antimicrobial resistance. Automating antibiotic decisions using machine learning could help improve treatment precision by improving probability predictions and relieve time pressure on prescribers, but there is not currently a decision algorithm that can replicate humans' ability to weigh up the relative value of different treatment options. Here, we automated antibiotic choice decisions algorithmically by developing and testing an individualised measure of treatment appropriateness - a utility function - that combines probability prediction of different treatment outcomes with measures of prediction confidence, illness severity, and the relative value of different antibiotic characteristics derived from real-world prescribers using innovative qualitative-quantitative techniques. The aim of this approach was to maximise the projected benefits and practicality of antibiotic treatment for urinary tract infection (UTI) while minimising harm and generation of antimicrobial resistance.

## Methods

XGBoost clinical prediction models were trained, tested, tuned, and validated to predict the risk of antimicrobial resistance, *Clostridioides difficile* diarrhoea, and drug toxicity for 13 antibiotics in patients with culture-positive urine specimens using open-source real-world pseudonymised electronic healthcare records. Prescribers from a range of primary and secondary care settings undertook a discrete choice experiment ranking exercise with fictional antimicrobial agents â€“ a ranked logit method was used to quantify the relative importance of different antimicrobial characteristics (e.g., oral bioavailability, toxicity, antimicrobial resistance risk) to prescribers. A utility function was written that combined these importance weights with probability predictions from the XGBoost models, prediction confidence (area under the receiver operating characteristic curve) and a hypothetical measure of illness severity to produce a utility value for each antibiotic for each patient. These utility values were then used to provide recommendations for urinary tract infection antimicrobial treatment in a microsimulation study design - the proportion of organisms grown in urine specimens that were susceptible to the recommended antibiotic, and the proportion of these recommendations that were WHO Access category antibiotics and had intravenous and oral routes of administration were measured across a range of hypothetical illness severities.

## Findings

Clinical prediction models were trained and validated on a dataset of 23,812 urine specimens and 86,682 antibiotic prescriptions. The microsimulation study was undertaken for 2,646 patients who had urine specimens sent. Area under the receiver operating curve for probability predictions ranged from 0.637 for ampicillin susceptibility to 0.888 for *C. difficile* diarrhoea. 49 prescribers participated in the discrete choice experiment from a range of primary and secondary care specialties - UTI-specificity of antibiotic agents most increased their probability of selection by prescribers, and high toxicity risk most reduced their probability of selection. A the lowest illness severity, nitrofurantoin had the highest utility (and was therefore recommended as individualised first-line therapy) in the majority of patients. The first-line treatment recommendations at this illness severity were active in vitro against the organism subsequently grown in 81.25% of cases, and there were a median of five susceptible results per specimen for the top six automated recommendations (IQR 4-6), with a median of three susceptible Access results (IQR 2-4). As illness severity increased, treatment recommendations initially diversified into a mix of agents with varying WHO AWaRe categories and available routes of administration, before converging predominantly on piperacillin-tazobactam at the highest illness severity. Treatment recommendations at the highest illness severity score were active in vitro against the organism subsequently grown in 92.94% of cases.

## Interpretation

Our antibiotic decision algorithm built on a prescribed-informed antimicrobial utility function could enable true AI-driven decision making in antimicrobial treatment and susceptibility testing and help nations meet the United Nations target of 70% WHO Access agent prescribing without compromising on probability of treatment efficacy. The innovative prescriber-informed approach used is flexible enough to be adaptable to a range of healthcare settings by allowing local clinician factors such as cost and patient cohort to influence the weights of different factors, as well as local epidemiology of resistance, toxicity, C difficile, and illness severity. Strengthening the prediction model by incorporating more healthcare data from local settings is likely to further improve performance. Clinical trials of the algorithm are required to determine the real-world impact of the approach on individuals and populations.

## Funding

This research was funded in part by the Wellcome Trust grant ref: 226691/Z/22/Z. For the purpose of open access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript version arising from this submission. Office for Life Sciences Data-Action Accelerator award also supported this work. The funders had no role in the conceptualisation, design, data collection, analysis, decision to publish or preparation of the manuscript.

# Introduction

Functioning antibiotics underpin functioning healthcare systems - antimicrobial resistance (AMR) is therefore a significant threat to the delivery of global healthcare.[@walshAntimicrobialResistanceAddressing2023] In September 2024, the United Nations General Assembly (UNGA) committed to ensuring that the safest, cheapest antibiotics with the lowest AMR risk (World Health Organisation \[WHO\] Access Category antibiotics) make up 70% of global antibiotic use in healthcare by 2030.[@un2024_amr] The challenge in achieving this goal is determining when it is safe to empirically use Access agents, which often have relatively narrow spectra of activity and will therefore be avoided in favour of more harmful Watch category agents to ensure treatment efficacy where there is doubt about the presence of resistance and/or perceived high stakes (e.g., systemically unwell patients). [@howardPersonalisedAntimicrobialSusceptibility2024, @rheeTrendsEmpiricBroadSpectrum2024]

Automating antimicrobial treatment choice using machine learning is therefore attractive because algorithms can better quantify the probability of resistance and treatment outcomes using clinical prediction models built on drug, patient, and pathogen characteristics.[@corbinPersonalizedAntibiogramsMachine2022] Algorithms, however, cannot judge the subjective value (or cost) of treatment outcomes to patients, populations, and healthcare systems.[@staderAlgorithmsDontHave2024] To make good antibiotic treatment decisions, algorithms need a mechanism to quantify the value of antibiotic treatment mathematically - a so-called utility function.[@walshUtilityFunctionsAutonomic2004] An automated system that makes antibiotic treatment choices using such a utility function could give prescribers the confidence to use Access category antibiotics when safe to do so, while compromising on Access antibiotic use in situations where treatment efficacy needs to be prioritised (e.g., where risk of resistance and/or clinical deterioration from untreated infection is high).

Here, we describe a urinary tract infection (UTI) treatment choice automation algorithm built on a utility function that combines clinical prediction models with prediction confidence, prescriber-informed outcome values/costs, and illness severity - the aim of this study is to assess the potential of this tool as decision support in helping to meet the UNGA 70% global Access antibiotic target without compromising individual patient safety.

# Methods

## Data Sources and Participants

The study complied with the PhysioNet MIMIC-IV dataset Data Use Agreement 1.5.0 and Health Data License. Approval was also obtained for the discrete choice experiment from the NHS Health Research Authority (HRA). A proportionate review was undertaken by a UK Research Ethics Committee (REC), which determined that full REC approval was not required. Clinical prediction models were developed using the open-source PhysioNet dataset MIMIC (Medical Information Mart for Intensive Care)-IV version 2.2, a pseudonymised inpatient and outpatient electronic healthcare record dataset for patients over the age of 18 who were admitted to intensive care or the emergency department between 2008 and 2019 at Beth Israel Deaconess Medical Center (BIDMC - Boston, MA) (<https://physionet.org/content/mimiciv/2.2/>).[@johnsonMIMICIVClinicalDatabase, @johnsonMIMICIVFreelyAccessible2023b, @goldbergerPhysioBankPhysioToolkitPhysioNet2000b]

Prediction models of antibiotic susceptibility probability were developed on urine specimen results with bacterial growth from the 'microbiologyevents' dataset (inpatients and outpatients), and prediction models of antibiotic outcomes were made using prescription data from the 'prescriptions' dataset (inpatients only). Antimicrobial susceptibility interpretations in the 'microbiologyevents' dataset are likely to be based on Clinical Laboratory Standards Institute clinical breakpoints given the U.S. setting.[@patelUpdatingBreakpointsUnited2023] Sample size was determined by the size of the available dataset, and provided a sufficient number of cases per independent variable in the model to reduce the probability of overfitting.[@bramerAvoidingOverfittingDecision2007] Antibiotic financial cost was determined using the lowest procurement/tender award price for each agent in U.S. dollars as listed on the U.S. Department of Veterans Affairs National Acquisition Center (<https://www.vendorportal.ecms.va.gov/NAC/>) when accessed in November 2024.[@supportVANationalAcquisition]

Antibiotic treatment value was determined using a discrete choice experiment survey completed online between June 1st 2024 and October 31st 2024 by antibiotic prescribers from general practice (GP), medicine, surgery, intensive care, and infectious diseases/medical microbiology in Liverpool, UK. Sample size was determined by the number of respondents in the 4-month survey period.

## Data preparation

Data preprocessing and quality checking was performed in a similar way across sociodemographic groups using RStudio version 2023.12.1+402, and followed a similar pattern to our previous work with the dataset with some additions.[@howardPersonalisedAntimicrobialSusceptibility2024, @rstudioref] The preprocessing workflow is summarised in Appendix 2. Data were quality checked at each stage throughout preprocessing using counts of organism species, results, antimicrobial names, missing data, numbers of rows and numbers of columns to detect preprocessing errors. Choices of predictor variables and their time horizons were based on indirect or direct causal plausibility and/or association with outcome variables.[@howardPersonalisedAntimicrobialSusceptibility2024] Allocation to training and validation datasets was performed individually for each model by random 80:20 split without replacement, stratified to maintain similar proportions of the outcome in the training and validation datasets. 39 outcomes were required for 39 individual models - 13 individual antibiotic susceptibility prediction models and 24 antibiotic combination resistance models on the urines dataset, and a *Clostridioides difficile* infection (CDI) prediction model and antibiotic toxicity prediction model on the prescriptions dataset.

The outcome for all antibiotic susceptibility prediction models was an 'S' result indicating susceptibility of the organism grown in that urine specimen to that antibiotic or antibiotic combination. The outcome for a CDI prediction model was a positive *C. difficile* stool result within three months of the start date/time of an antibiotic or antibiotic combination. The outcome for an antibiotic toxicity prediction model was a composite outcome of either stage three acute kidney injury (a new increase in serum creatinine to at least three times baseline or at least 3.54Âµmol/dL in the absence of co-administration of nephrotoxic drugs as defined by the British National Formulary or intravenous contrast during the associated hospital admission), deranged liver function tests (a result newly above the upper end of the normal range for alanine aminotransferase, aspartate aminotransferase, or alkaline phosphatase in the absence of previous coded chronic liver disease or biliary instrumentation in the associated hospital admission), marrow suppression (new anaemia, leukopenia, or thrombocytopenia in the absence of co-administration of cytotoxic drugs as defined by the British National Formulary) or coded bleeding diagnosis in the associated hospital admission) in the seven days following the start date of an antibiotic or a coded antibiotic adverse event for the associated hospital admission.[@Appendix1Interactions,@kongIncidenceCharacteristicsRisk2021, @tammaAssociationAdverseEvents2017]

The selection process for predictor and outcome variables was undertaken by the lead author (Consultant in Medical Microbiology, male, 30s, white British) and reviewed by co-authors (all male in the age range 30-60 with a racial mix of white British, White Australian, Maltese, Indian, and Chinese). Outcome and predictor variables were selected consistently across sociodemographic groups. No blinding to allocation or predictor/outcome assessment was implemented at any stage.

## Clinical prediction models

The overall design of the utility function is summarised in Figure 1.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/Utility function design.pdf")

```

Figure 1: Design of the utility function. A human approach to antibiotic decision making was approximated by combining probability predictions with prediction confidence, the relative value of different treatment characteristics, and the consequences of treatment failure (represented by illness severity).\

We have described clinical prediction models of resistance for 12 of the 13 antimicrobial agents using logistic regression in our previous work.[@howardPersonalisedAntimicrobialSusceptibility2024] For this study, XGBoost (an ensemble method that improves predictive accuracy by sequentially combining multiple decision trees, used with the 'xgboost' package <https://cran.r-project.org/web/packages/xgboost/index.html>) was used instead because it was found to achieve higher initial area under the receiver operating characteristic curve (AUROC) values for the majority of the 12 clinical prediction models when trained and validated on the same datasets.[@chenXgboostExtremeGradient2014, @chenXGBoostScalableTree2016] The same XGBoost technique was used for all 39 models. The output of each model was the probability of the binary outcome's positive class (an 'S' result, CDI, or antibiotic toxicity).

XGBoost models were trained and tuned on the training datasets using L2 regularisation (ridge penalty) to control overfitting. Area under the receiver operating characteristic curve (AUROC) was used as the model evaluation metric. Hyperparameter tuning was performed sequentially for each of the 39 models across parameters in 3 stages. 10 sets of paired values for maximum tree depth (selecting values between two and nine inclusive) and minimum child weight (selecting values between one and 10 inclusive) were randomly selected using Latin hypercube sampling with 'randomLHS' from the 'lhs' package (<https://cran.r-project.org/web/packages/lhs/index.html>) - a 5-fold cross-validation was then performed across 50 boosting rounds for each of these 10 pairs of values, with a default learning rate of 0.05, a proportion of cases used for each decision tree (subsample rows ratio) of 0.8, and a proportion of predictors used for each decision tree (subsample columns ratio) of 0.8.[@carnellLhsLatinHypercube2006]

The maximum tree depth and minimum child weight values that produced the highest AUROC were carried forward to another set of 5-fold cross-validations with 50 boosting rounds across 10 paired subsample rows and columns ratios (again randomly selected using 'randomLHS', with both values sampling from a range between 0.5 and 1.0 inclusive) with a learning rate of 0.05. The subsample rows and columns ratios that produced the highest AUROC were carried forward to a final set of 5-fold cross-validations across four learning rates (0.1, 0.05, 0.01, and 0.001), with a maximum number of boosting rounds of 1000 and early stopping if AUROC did not improve for 50 rounds.

The learning rate and the round number at which the best AUROC value occurred (forming the new total number of rounds parameter) were then taken forward as parameters for training the final model. Class imbalance methods (e.g., class weighting) were not used to ensure that probability predictions were not skewed to improve predictive performance (e.g., universally increased to improve sensitivity), given that they would subsequently be used to inform the utility function.

Predictor variable contributions to predictive value in model training were measured using Shapley values with 'predict' from the 'stats' package.[@Chapter53Shapley] Predictor variables with Shapley values of zero were then excluded from models for the final training round. A single validation run was then performed with the final trained model on the validation dataset, measuring AUROC, accuracy, precision, recall, and F1 score (decision threshold 0.5) using coded formulae for each model. 95% confidence intervals were approximated for each metric using a bootstrap method with 1000 iterations.

A model stability analysis was performed for each model excluding the 24 antibiotic combination models (15 models in total) in view of the computational time required, where training and validation of the final model was performed in six random train-test splits without replacement (stratified by outcome) for each of four smaller train-test dataset size ratios (2:98%, 6:94%, 8:92%, and 12:88%) - AUC, accuracy, precision, recall, and F1 score were measured for each of these validations, and metric distributions were plotted using dot plots to assess heterogeneity in performance.

A model fairness analysis was performed where each of the same 15 trained models was validated separately across a range of protected characteristics (race, age, marital status, first language, and gender), with six random-train-test splits per characteristic - AUC, accuracy, precision, recall, and F1 score (decision threshold 0.5) were again measured for each of these validations, and metric distributions plotted using dot plots. Threshold recalibration for fairness was not performed because the output of the models were probabilities rather than classifications.

A time cluster analysis was performed to assess out-of-sample performance, where the 15 models were trained on one of four time periods (2008-2010, 2011-2013, 2014-16, and 2017-2019), then validated on that period and the other four time periods, measuring AUC, accuracy, precision, recall, and F1 score (decision threshold 0.5) - this was repeated with six random train-test splits for each pair of time periods, and metric distributions were plotted using dot plots.

## Prescriber discrete choice experiment

A questionnaire was devised (see Appendix 1) where 13 fictional antibiotics were created and given six characteristics: the AWaRe classification of the antibiotic (yes or no); the CDI risk of the antibiotic (high or low); the toxicity risk of the antibiotic (high or low); whether the antibiotic was only indicated for UTI (yes or no); whether the antibiotic was orally-administrable (yes or no); whether the antibiotic was intravenously-administrable (yes or no); the financial cost of the antibiotic (high or low).[@buddAdaptationWHOEssential2019] Participants were given a fictional UTI clinical scenario, then asked to rank the treatments in order of suitability.

The questionnaire was distributed to participants using SurveyMonkey (<https://uk.surveymonkey.com>) over a 4-month period (1st June 2024 to 21st October 2024) via organisational and departmental single points of contact in infection specialties, medicine, surgery, intensive care, and general practice in Liverpool by email invitation, and written consent for participation was obtained.[@SurveyMonkeyWorldsMost] No minimum sample size was stipulated, but the aim was to obtain at least some participants from each specialty.

The ranking of each antibiotic (1-13) by each participant was recorded and converted to a long format where each participant's chosen rank order of antibiotics was treated as a series of choices using the 'mlogit.data' method from the 'mlogit' package.[@croissantEstimationRandomUtility2020] A conditional logit model was built to estimate the probabilities of each observed rank from the choice data based on the six characteristics of each antibiotic (again using 'mlogit'). The model was trained to estimate maximum log likelihood using the Broydenâ€“Fletcherâ€“Goldfarbâ€“Shanno (BFGS) method.[@daiPerfectExampleBFGS2013]

The coefficients for each characteristic were then extracted from the model and used to represent the relative weight of each antimicrobial characteristic to the expert participants in making an antimicrobial treatment choice for UTI. Coefficients were analysed using data visualisation by bar plot, with 95% confidence intervals approximated using a bootstrap method with 1000 iterations. A sensitivity analysis was performed where the approach was repeated on subsets of the data to build separate models for infection specialties, medicine, surgery, intensive care, and general practice to compare the weights of the six antimicrobial characteristics to different specialties.

## Utility calculation

Treatment utility was calculated individually for each patient/urine specimen in the microsimulation dataset using the following process:

1.  The trained clinical prediction models were used to predict the probability of antimicrobial susceptibility, CDI, and toxicity for each antibiotic (and antibiotic combination) on each urine specimen. These values were then weighted (multiplied) by their respective AUROC values on the test dataset to reflect confidence in the probability estimates.

2.  Probabilities were added for each known binary characteristic of each antibiotic - UTI-specificity, oral administration option, and intravenous administration option, with a probability of one for yes and zero for no. Separate binary variables were created for Access and Reserve categories, also with a probability of one for yes and zero for no (watch category agents were zero for both).

3.  Financial cost was calculated for each antibiotic using the lowest available cost of an antibiotic in U.S. dollars as listed on the U.S. Department of Veterans Affairs National Acquisition Center - these costs were divided by the highest cost including combinations of antibiotics, producing normalised numbers between zero and one.[@supportVANationalAcquisition]

4.  A personalised utility value was calculated for each antibiotic for each patient using a bespoke mathematical expression (see Appendix 3) that performs two functions: firstly, it weights the values for each antimicrobial characteristic from steps 1-3 using their respective weights from the discrete choice experiment; secondly, it incorporates an illness severity variable that weights the contribution of antibiotic susceptibility probability and intravenous administration to overall utility more heavily as it increases (reflecting the fact that antibiotic efficacy and the availability of intravenous routes of administration are more important in patients with sepsis).[@buckmanEmpiricAntibioticsSepsis2018]

The distributions of utility values at an illness severity value of zero were plotted across the microsimulation dataset for each antibiotic and antibiotic combination using a box and whisker plot. Sensitivity analyses where the utility distribution was repeatedly calculated on the microsimulation dataset across a range of zero to one for susceptibility probability, CDI probability, toxicity probability and normalised cost, and a range of minus two to two for characteristic weights (at an illness severity value of one so that intravenous treatment utility was not flat across all values) - changes in overall utility distribution in the microsimulation dataset across these ranges were then plotted for all antibiotics using line plots.

## Microsimulation study design

An individual-level simulation (microsimulation) study design was used to assess projected outcomes of the decision algorithm.[@DynamicMicrosimulationModels] The single antibiotic with the highest utility value for each patient in the microsimulation dataset was selected as the personalised first-line treatment recommendation for that patient. The antibiotic with the second-highest utility was chosen as second-line option, and so on until all 13 antimicrobial agents were ranked as treatment recommendations in order of utility value for each patient. Sensitivity analyses were performed to assess the effect of increasing the illness severity weight on the proportion of subsequent isolates that were covered by all recommendations, Access-category recommendations, recommendations with oral routes of administration, and recommendations with intravenous routes of administration - these results were plotted using area and line plots respectively. Illness severity values were hypothetical (reliable contemporaneous measures of illness severity were not available in the dataset) and ranged from zero up to the number at which the proportion of subsequent isolates that were covered by all recommendations visibly plateaued. Proportions were compared visually against a standard first-line option for systemically well patients (nitrofurantoin) and for critically ill patients (piperacillin-tazobactam) - these agents were selected as comparators because they were the oral and intravenous antibiotics respectively that had the highest rates of susceptibility in the dataset. The median and interquartile range of the number of susceptible results in the top six recommendations was also measured and compared to a standard top six of nitrofurantoin, trimethoprim/sulfamethoxazole, gentamicin, piperacillin/tazobactam, ceftriaxone, and ciprofloxacin (based on a combination and WHO and European Society of Urology UTI treatment guidelines, and as described for directing antimicrobial susceptibility testing in our previous work.[@howardPersonalisedAntimicrobialSusceptibility2024, @EAUGuidelinesUrologicala, @WHOAWaReAccess]

The illness severity sensitivity analysis was then repeated firstly to examine second-line treatment recommendations (antibiotics with the second-highest treatment utility), then secondly with antimicrobial combinations also included as treatment options, then thirdly to assess the potential effect of improved probability predictions for single-agent recommendations (the latter by taking the mean of the predicted probability and the actual outcome denoted by one or zero) - outcomes and antibiotics recommended were again plotted across illness severity using area and line charts respectively. The analysis was repeated again to assess the effect of increased illness severity on the predicted CDI risk, toxicity risk, and minimum financial cost of first-line treatment recommendations. A similar sensitivity analysis was performed to assess the effect of increasing nitrofurantoin resistance probability from zero up to one on the four outcomes listed above and antibiotics recommenced, plotting the results using an area and line chart respectively.

# Results

## Participants

The characteristics of patients, antimicrobial agents, and specimens in the model development and microsimulation datasets are summarised in Appendix 4. The proportion of all patient/specimen characteristics between the urine model development dataset and microsimulation dataset were comparable. A higher proportion of specimens in both urine datasets came from females than males, while the number of prescriptions for all indications in the prescription dataset was approximately equal between males and females. 60-69 was the most prevalent age group in the prescription dataset, while 70-79 was the most prevalent age group in both urine datasets. A higher proportion of patients in the prescription dataset had English recorded as spoken language than in either urine dataset - this probably reflects the fact that the prescription dataset pertained only to inpatients (where more detailed data collection may have been performed), while the urine dataset pertained to both inpatients and outpatients. The numbers of different antibiotic types prescribed in the prescription dataset are summarised in Appendix 5.

## Clinical prediction model specification and performance

Final training hyperparameters used for each model are summarised in Appendix 6, and predictor variable contributions to predictive performance are summarised in Appendix 7. The presence and/or absence of previously-detected resistance to an antibiotic in the last year was one of the largest contributors to predictive accuracy for susceptibility to that antibiotic in most models. Gender and age group were large contributors to antibiotic susceptibility predictive performance in all models. Hospital admission in the last year, age over 65, previous CDI, and previous acute kidney injury in the last year were among the largest contributors to predictive performance for both CDI and antibiotic toxicity.

ROC curves and performance metrics for models predicting single-antibiotic susceptibility, *C. difficile* infection (CDI), and toxicity in the single validation run on the validation dataset are summarised in Figure 2 and Table 1 respectively. ROC curves and performance metrics for models predicting susceptibility to 2-antibiotic combinations are summarised in Appendix 8 and Appendix 9 respectively.

```{r, echo=FALSE,message=FALSE,warning=FALSE}

knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/roc_plots_main.pdf")
  
```

Figure 2: ROC curves for probability predictions made for single-antibiotic susceptibility, *C. difficile* infection (CDI), and toxicity on the validation dataset.\

```{r, echo=FALSE,message=FALSE,warning=FALSE}

metrics_singles_table <- read_csv("/Users/alexhoward/Documents/Projects/UDAST_code/metrics_singles_table.csv")

knitr::kable(metrics_singles_table)

```

Table 1: Model performance metrics for prediction of single-antibiotic susceptibility, CDI, and antibiotic toxicity in the single validation run on the validation dataset. 95% confidence intervals are displayed in parentheses. \

Performance metrics from the small training dataset stability analysis are summarised in Appendix 10. The largest difference in mean AUROC across six model train-test iterations was observed between the 2% and 12% training datasets in the CDI prediction model (0.132, 0.631 versus 0.763), and the largest AUROC standard deviation was observed in the 2% dataset in the CDI prediction model (0.025). Performance metrics from the year group cluster analyses are summarised in Appendix 11. For all models and all year groups, mean AUROC across six train-test iterations was highest in the same year group upon which the model had been trained. The largest difference in AUROC between year groups was observed for the toxicity prediction model between 2011-2013 training, 2011-2013 testing and 2011-2013 training, 2014-2016 testing (0.257, 0.880 versus 0.623). The largest AUROC standard deviation was observed for the CDI model with 2008-2010 training, 2011-2013 testing (0.091).

Performance metrics from the model fairness analyses are summarised in Appendix 12. The largest difference in mean AUROC across six model train-test iterations in the age fairness analysis was observed between the 40-49 and 80-89 age groups for piperacillin-tazobactam susceptibility prediction (0.136, 0.831 versus 0.695), and the largest AUROC standard deviation was observed for CDI prediction in the over 90s age group (0.077). The largest difference in mean AUROC across six model training iterations in the race fairness analysis was observed between Hispanic patients and the aggregate group containing the least prevalent local races (i.e., not Asian, black, or white) for ciprofloxacin prediction (0.093, 0.738 versus 0.646), and the largest AUROC standard deviation was observed in Asian patients for CDI prediction (0.078). The largest difference in mean AUROC across six model training iterations in the remaining characteristics was observed between females and males - this difference was most marked in susceptibility prediction models for cephalosporins, meropenem, and gentamicin, with the largest difference in mean AUROC observed for meropenem (0.102, 0.727 versus 0.625), and the largest AUROC standard deviation observed in piperacillin-tazobactam susceptibility prediction for males (0.023).

## Discrete choice experiment

49 prescribers participated in the discrete choice experiment (15 from infection specialties, 11 from other medical specialties, nine from surgical specialties, nine from intensive care, and five from general practice). The coefficients from the ranked logit analysis of the discrete choice experiment across all specialties are displayed in Figure 3, and the coefficients by individual specialty are displayed in Appendix 13. Overall, an antibiotic being specific to urinary tract infection in its licensed indication appeared to have the most positive effect on its probability of selection in the discrete choice experiment, and high toxicity risk the greatest negative effect on its probability of selection. High antibiotic cost appeared to have the least effect on probability of antibiotic selection, exhibiting a minimal positive effect with the approximated 95% confidence interval crossing the line of no effect.

```{r, echo=FALSE,message=FALSE,warning=FALSE}

knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/ORplot.pdf")

```

Figure 3: Coefficients from the ranked logit analysis of the discrete choice experiment across all prescriber specialties.\

General practitioners and infection specialists were more likely to select antibiotics with oral routes of administration, and less likely to select antibiotics with intravenous routes of administration - the opposite was observed in intensive care and medical specialty prescribers, where intravenous routes of administration were preferred over oral routes. Routes of administration appeared to have less bearing on choice in surgical specialties than in other specialties. In medical specialties and intensive care, an antibiotic being in the WHO Access category most increased the probability of selection. Intensive care was the only specialty in which an antibiotic being in the WHO Reserve category reduced the probability of selection more than high toxicity risk. Wide estimated confidence intervals for coefficients derived from general practitioners reflected the low numbers of respondents from that prescriber group (n=5).

## Utility function

The distributions of single-antimicrobial choice utility values for patients across the microsimulation dataset are displayed in Figure 4, The distributions of single-agent utility values stratified by prescriber types are displayed in Appendix 14, and the distribution of all antibiotic options including 2-agent combinations are displayed in Appendix 15.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/utility_Treatment_ (single agent).pdf")
```

Figure 4: Distributions of antimicrobial choice utility values for patients across the microsimulation dataset.\

At the lowest illness severity, nitrofurantoin had the highest median treatment choice utility in the microsimulation dataset. For single-agent treatment, five of the six antibiotics with the highest median utility were WHO Access agents - the only exception to this was piperacillin-tazobactam, which placed fourth overall amongst single agents. The lowest-placed WHO Access antibiotic was ampicillin (or amoxicillin), which placed 12th out of 13 agents. Vancomycin was the lowest-placed antibiotic choice for the majority of patients in terms of median utility across the population. The widest spread in utility values was observed for cefazolin (IQR 1.57), reflecting the fact that predicted probability of susceptibility to cefazolin varied the most across the population (IQR 0.279).

Nitrofurantoin was the highest-placed agent for all prescriber specialties in terms of median utility across the population, and the placement of other agents was more variable. The largest differences observed between antibiotic utility values were between general practice and intensive care - agents with oral routes of administration ranked higher in the former, while those with intravenous routes of administration ranked higher in the latter. When two-agent combinations were included in the general analysis, ampicillin plus gentamicin became the second-placed treatment option in terms of median utility across the population (behind nitrofurantoin), meropenem plus vancomycin the third, and piperacillin-tazobactam plus ciprofloxacin the fourth.

The sensitivity analyses that examined the effect of varying different utility function parameters on overall treatment choice utility are displayed in Appendix 16. The largest factor in the sensitivity of antibiotic utility to parameter changes within the utility function was probability of susceptibility, reflecting the fact that they were being multiplied this value - the steepest corresponding increases/decreases in utility when most parameters were varied were therefore observed for piperacillin-tazobactam because it had the highest median predicted probability of susceptibility (0.899). When probability of susceptibility or susceptibility prediction AUROC were varied, the combined value of all other parameters in the utility function became more important - nitrofurantoin therefore exhibited the steepest corresponding increases/decreases in utility in response to changes in and. There was little variation in utility function sensitivity between antibiotics when CDI importance weight was varied, reflecting low median predicted probabilities of CDI in the dataset (all values for single agents falling between 0.002 for meropenem and 0.001 for cefazolin). There was more variation in utility between antibiotics when toxicity importance was varied, reflecting a wider variation in toxicity probability (all values for single agents falling between 0.190 for meropenem and 0.071 for nitrofurantoin). Varying AUROC values for CDI and toxicity prediction had little effect on overall utility values.

## Microsimulation

The results of the illness severity microsimulation study are displayed in Figures 5 and 6.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of WHO Access agents)_susplot.pdf")
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of orally-administrable agents)_susplot.pdf")
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of IV-administrable agents)_susplot.pdf")
```

Figure 5: The proportion of organisms subsequently grown in urines that were covered by the automated first-line antibiotic treatment recommendation depending on illness severity, with the proportion of Access category agents (top), agents with oral routes of administration (middle), and agents with intravenous routes of administration (bottom) providing coverage also indicated.\

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/illness_abplot.pdf")

```

Figure 6: The make-up of automated first-line treatment recommendations by antibiotic agent depending on illness severity.\

At the lowest illness severity, nitrofurantoin was the first-line treatment recommendation in almost all cases, covering 81.25% of organisms subsequently grown. There were a median of five susceptible results per specimen for the top six automated recommendations (IQR 4-6), with a median of three susceptible Access results (IQR 2-4, see Appendix 17). As population illness severity was increased, the proportion of organisms covered and the provision of an IV treatment option increased accordingly, both reaching a plateau at 92.94% for the most unwell patients. Likelihood of coverage for a patient population with severe illness was achieved by the algorithm at the expense of recommending Access treatment options and oral treatment options (which fell to 1.25% and 1.75% respectively for the most unwell patients) - this was largely driven by a switch of automated recommendations to piperacillin-tazobactam as population illness severity was increased. At intermediate levels of illness severity, the proportion of Access agent recommendations was maintained by the algorithm by increasing recommendations for cefazolin or gentamicin.

The proportion of organisms covered by second-line automated recommendations (Appendix 17) initially increased with illness severity due to nitrofurantoin falling to second-line option, but as intravenous treatment was prioritised, the proportion of coverage fell back to 80.2%. The proportion of Access category agents with coverage was preserved at 30.2% at high illness severity owing to higher proportions of gentamicin recommendations than for first-line treatment

When combinations of antimicrobial agents were included (Appendix 18), automated treatment recommendations were able to cover a higher proportion of the most unwell population (98.5%) by recommending either meropenem and vancomycin, piperacillin-tazobactam and ciprofloxacin, or piperacillin-tazobactam and trimethoprim-sulfamethoxazole. At intermediate levels of illness severity, the proportion of Access agent recommendations was maintained by the algorithm by increasing recommendations for ampicillin and gentamicin.

Artificially improving probability predictions (Appendix 19) increased the proportion of organisms covered by first-line treatment recommendations for all levels of illness severity (98.8%), preserving 28.3% Access and 30% oral antibiotic recommendations even at the highest levels of illness severity while increasing the number of recommendations with IV preparations to 98.7%.

Median predicted CDI probability from automated recommendations remained low as illness severity increased. Median predicted antibiotic toxicity probability from automated recommendations increased from 0.072 to 0.164 as illness severity increased. Median minimum U.S. drug cost increased from \$18.80 to \$22.10 as illness severity increased.

Increasing median nitrofurantoin predicted resistance probability (Appendix 20) reduced the proportion of first-line automated recommendation organism coverage to a nadir of 65.5% at a median resistance probability of 43.3%. As nitrofurantoin resistance predictions rose above 50%, the coverage proportion rose to 78.9% as the algorithm selected more gentamicin, ampicillin/sulbactam, and cefazolin as first-line therapy instead of nitrofurantoin.

# Discussion

This study shows that automation of empirical antibiotic decision making for individual patients using a utility function built on clinical prediction modelling, prescriber discrete choice experiments, and measures of illness severity could help safely maximise the use of WHO Access category antibiotics in clinical practice while minimising the risk of clinical failure due to resistance. Where illness severity was very low or very high, our algorithm behaved much like a fixed antimicrobial formulary - well patients (i.e., patients with uncomplicated lower UTI) were almost exclusively recommended nitrofurantoin and very unwell patients (i.e., patients with urosepsis) were almost exclusively recommended piperacillin-tazobactam. The algorithm was able to provide more nuance than an antimicrobial formulary in the grey area in between these two patient cohorts - as illness severity increased, our algorithm gradually compromised on the use of Access agents to reduce the probability of clinical failure and prioritise agents that could be administered intravenously.

Our algorithm can safely navigate antibiotic decision making for three reasons: firstly, clinical prediction modelling is likely to provide more objective estimates of the probability of antibiotic outcomes than human clinicians who can be vulnerable to psychological phenomena such as the availability heuristic (where the importance of events influences perception of their probability); secondly, the algorithm leverages the experience of real-world prescribers by quantifying how important they perceive different factors to be in a theoretical scenario where they can be dispassionate and objective; thirdly, the utility function is constructed to weight intravenous antibiotics and probability of susceptibility more heavily as patients become more unwell, allowing the algorithm to replicate a key aspect of clinical judgement in antibiotic prescribing - weighing up the risk of untreated infection against antibiotic-related harm and AMR generation.

We envisage that our algorithm could be implemented at the point of a clinician ordering a urine culture test - in response to the test order for a patient, the utility of different antibiotic options for that individual patient are calculated using probability predictions based on the patient's prior healthcare data, importance weights from a local discrete choice experiment, and an illness severity score (e.g., National Early Warning Score \[NEWS\]). The top three antibiotics are communicated to the clinician through the test ordering interface as first, second, and third-line recommendations, and the top six antibiotics are chosen for susceptibility testing (see Figure 7). For this to be done safely, local calibration of the utility function to the chosen illness severity score will need to be performed with input from expert prescriber stakeholders by tweaking the built-in severity weight and gauging its effect with the sensitivity analysis displayed in Figure 5 - this will ensure that coverage rates are acceptable to local users of the algorithm (e.g., a coverage of at least 90% may be desired once a patient's NEWS is 5 or above). The algorithm could also be easily adapted to account for known antibiotic allergies and other contraindications when making prescribing recommendations - this was not done in this study because reliable allergy information was not available in the dataset.

```{r, echo=FALSE,,warning=FALSE}

glue(
  
  "URINE CULTURE: INTERIM REPORT
  
  Patient: BETA, Alpha (NHS 123 456 7890):
  
  In your test request, you have stated that there are clinical features of UTI.
  
  Empirical treatment recommendations:
  First-line: Nitrofurantoin (85% probability S)
  Second-line: Ciprofloxacin (90% probability S)
  Third-line: Ampicillin/sulbactam (85% probability S)
  
  Urine culture will be performed,
  along with the following susceptibility tests:
  Nitrofurantoin
  Ciprofloxacin
  Ampicillin/sulbactam
  Piperacillin/tazobactam
  Gentamicin
  Cefazolin
  
  Further results to follow.
  Please direct any queries regarding
  this report to Medical Microbiology."
)

```

Figure 7: Example of a potential output from the antibiotic decision algorithm as an immediate interim report to a clinician when a urine culture request is made an a box is ticked stating that the patient has clinical features of urinary tract infection.\

Subsetting the discrete choice experiment by specialty highlighted that the utility function can and should be adapted for the setting in which it will be used to direct automated prescribing decisions - the experiment revealed, for example, that intensive care physicians had different needs and priorities to general practitioners when presented with the UTI clinical scenario. Cost was not a high priority for any prescribers, but in low and middle income countries (LMICs) this may be given a much higher weight by local prescribers in the discrete choice experiment, and therefore in the automated prescribing decisions it informs. A lack of mature data infrastructure in LMICs may provide a barrier to the implementation of personalised algorithmic prescribing decisions, but the utility function approach may also be useful for population-level and policy-level decisions (for example, informing LMIC formularies or directing antibiotic supply chains).

The benefit of the microsimulation approach is that it helped gauge the performance of the algorithm in a more meaningful and practical way than metrics like AUROC alone. The fact that the decision algorithm was unable to provide a higher probability of organism coverage for very unwell patients than piperacillin-tazobactam (the antibiotic in the study with the highest probability of coverage of organisms grown) shows that the algorithm's susceptibility probability predictions were not able to detect rare resistance with sufficient sensitivity to provide additional benefit over a 'one-size-fits-all' approach in the most unwell patients. When probability predictions were artificially improved, the performance of the decision algorithm also improved in this respect - the recommended antibiotic was more likely to cover the organism grown at all levels of illness severity.

Another benefit of improving predictions would be resolving issues of fairness in probability predictions - the main issue noted in our fairness analysis was that AUROCs were lower for males when predicting susceptibility to several antibiotics. Because a classification approach was not used here, methods to resolve this such as decision threshold modification were not possible - our algorithm instead weighted probability predictions by their AUROCs so that agents with higher prediction probability confidence were prioritised. The most effective way to improve fairness, however, would be more data collection from under-represented groups - predictions were likely to be poorer in males because UTI is less common in that cohort so they were less well-represented in the training dataset. More data collection may also help to improve out-of-sample performance - probability predictions in this study were worse when models were trained on one time period and tested on another, reflecting how AMR constantly changes over time.

The decision algorithm is able to adapt to different resistance rates - when nitrofurantoin resistance probabilities were increased in the sensitivity analysis, the algorithm initially continued to select nitrofurantoin first-line due to the expressed priorities of prescribers in the discrete choice experiment (UTI-specificity, oral administration, and Access category), despite falling probability of organism coverage. The algorithm reached a tipping point once nitrofurantoin resistance probability hit a particular threshold, other antibiotics were selected first-line, and probability of coverage rose again. This phenomenon demonstrates that despite the utility function being a linear mathematical expression, the effects of changing real-world circumstances on decisions (and therefore potentially patient outcomes) are not necessarily linear. Another example of this is second-line treatment recommendations - because this worked by choosing the antibiotic that ranked second, probability of coverage rose and fell with increasing illness severity as nitrofurantoin temporarily became the second-line agent as it fell down the utility rankings.

An assumption made in the main analyses of this study is that a single antibiotic is preferable as empirical treatment. It is possible, however, that as AMR increases globally, combination regimens may become increasingly desirable and/or necessary - this is already reflected in some treatment guidelines, particularly where allergies and other drug contraindications make achieving adequate empirical coverage with a single antibiotic difficult. In this study, the decision algorithm was able to achieve higher rates of coverage than universal piperacillin-tazobactam treatment once combinations of agents were included. Predicting outcomes from antibiotic combinations using retrospective real-world data is challenging, due to its relative rarity in many settings - the benefit of using an adaptive approach with up-to-date real-world data, however, is that algorithmic decisions should further improve if combination therapy becomes more common.

Our study had several limitations: firstly, the urine dataset was limited to patients with secondary care contact and the prescription dataset to inpatients only - given that the benefits of the algorithm are likely to be highest in primary care because that is where the majority of antibiotic prescribing occurs, the approach needs to be validated in primary care settings; secondly, although the microsimulation approach can indicate how recommendations would have covered organisms grown here, it cannot determine whether recommendations would have been followed, or examined potential outcomes in instances of UTI where organisms are not grown - the decision algorithm therefore needs to be validated in a clinical trial setting with appropriate outcomes that incorporate innovative health economic analyses to best ascertain overall patient and population impact; thirdly, the number of respondents to the discrete choice experiment was lowest in the general practitioner group, which may reflect that this cohort are among the busiest and therefore did not have time do undertake the survey - paradoxically, it is these specialty cohorts in which a decision support algorithm may have the most benefit, so further work is required to understand how best to engage busy clinicians in qualitative-quantitative study approaches.

Despite these limitations, this study demonstrates how an innovative algorithmic decision approach that constructs a utility function from quantification of the key considerations for antimicrobial prescribing decisions (namely probability of different outcomes, the importance of different outcomes, and the consequences of inaccurate predictions) could help countries achieve the WHO target of 70% Access category antibiotic prescribing by 2030 in a way that does not endanger agent efficacy where it matters most - in severely ill patients at high risk of deterioration from sepsis. Further research is required in a clinical trial setting across multiple geographical areas to better understand the impact of our automated decision algorithm on individual and population outcomes.

# References

::: {#refs}
:::

## Funding

This research was funded in part by the Wellcome Trust grant ref: 226691/Z/22/Z. For the purpose of open access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript version arising from this submission. Office for Life Sciences Data-Action Accelerator award also supported this work. The funders had no role in the conceptualisation, design, data collection, analysis, decision to publish or preparation of the manuscript.

## Conflicts of interest

Alex Howard declares personal consulting work for Pfizer outside the submitted work, and a donation from Pfizer to the University of Liverpool for a public and professional engagement project outside the submitted work.

## Data sharing

The MIMIC-IV version 2.2 data set is publicly accessible as a credentialed PhysioNet user at https://physionet.org/content/mimiciv/2.2/ once mandated training is completed, and the data use agreement is signed. Additional aggregate-level data can be provided by the authors if requests to do so are in line with legal and ethical data use regulations. Open-source code written for this study will be made available upon publication.

## Code sharing

Open-source code to reproduce the study using the above dataset is available at <https://github.com/amh312/Antimicrobial_utility>.

## Contributions

AH conceived the study, performed data engineering and mathematical modelling, and wrote the manuscript including diagrams.

## Patient and public involvement

Provide details of any patient and public involvement during the design, conduct, reporting, interpretation, or dissemination of the study or state no involvement
