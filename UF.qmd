---
title: "Automating personalised antibiotic choices using a machine learning-based utility function: a microsimulation study"
format:
  docx:
    reference-doc: doc_template.docx
bibliography: UF_references.bib
csl: /Users/alexhoward/Zotero/styles/the-lancet-infectious-diseases.csl
editor: visual
---

Alex Howard\*\
\*corresponding author alexander.howard\@liverpool.ac.uk\
\*\*joint senior author

```{r, echo=FALSE,message=FALSE,warning=FALSE}

library(tidyverse)
library(knitr)
library(glue)

```

# Research in context

**Evidence before this study**

Antibiotic prescribing is a key driver of antimicrobial resistance (AMR) – the World Health Organisation (WHO) has therefore set a target for countries to reduce their use of harmful, broad-spectrum antibiotics by 2030. Meeting this target is made challenging by the tension between the need to ensure antibiotic efficacy in patients at high risk of clinical deterioration and the need to minimise individual/population harm from antibiotic treatment. Machine learning is a promising tool when applied to healthcare data to help make empirical treatment decisions that balance these elements because of its ability to predict antibiotic treatment outcomes. Its suitability for this application, however, is hampered by the lack of a robust utility function – a mathematical equation that safely quantifies the value of different antibiotic treatment options by weighting the importance of predicted treatment outcomes. 

**Added value of this study**

In this study, we construct a utility function that calculates the value of 13 different antibiotic treatment options for individual patients with urinary tract infection (UTI). The utility function uses clinical prediction models to calculate the probability of different antibiotic outcomes in individual patients, then weights these probabilities by their importance according to a panel of expert prescribers. The utility function manages the tension between antibiotic efficacy and harm by prioritising treatment efficacy over medium- and long-term individual and population considerations (e.g., development of antibiotic resistance) as illness severity increases. We use a microsimulation study design on real-world prescribing and microbiology data that demonstrates the ability of this utility function to inform safe antibiotic recommendations for UTI. 

**Implications of all the available evidence**

The utility function described in this study could power decision support tools that leverage data, machine learning, and domain expertise to help clinicians, healthcare providers, and countries reduce medium- and long-term antibiotic harm to individuals and populations without compromising on treatment efficacy in patients at risk of deterioration. Further clinical research with decision support tools for antibiotic treatment and testing based on the utility function is required across a range of populations to better understand the impact of the algorithmic decision approach on individual and population outcomes. 

# Abstract

## Background

Data-driven decision support tools that incorporate machine learning could improve individual and population outcomes from antibiotic treatment by predicting these outcomes to personalise antibiotic treatment – to do this effectively requires a utility function that quantifies the value of different antibiotic treatment options. Here, we construct and assess a utility function that personalises urinary tract infection (UTI) antibiotic treatment by combining machine learning algorithms with real-world expert prescriber intuition. 

## Methods

Retrospective healthcare data was used to calculate treatment utility for 13 antibiotics in 2,646 patients whose urine was sent for culture, using Boolean values for antibiotic characteristics, data-informed probability predictions for antibiotic treatment outcomes, coefficients from a prescriber antibiotic ranking scenario exercise for outcome importance, and a user-defined value for illness severity. The proportion of urine pathogens covered by WHO Access category, oral, and intravenous simulated utility-based personalised UTI treatment recommendations were measured.

## Findings

At the lowest illness severity, the utility function recommendation successfully covered the urinary pathogen with an Access antibiotic in 80.99% (n=2,143) of cases, an oral antibiotic in 80.49% (n=2,130) of cases, an intravenous antibiotic in 0.76% (n=20) of cases, and 81.25% (n=2,151) of cases overall. As illness severity increased, overall case coverage gradually increased to a peak of 92.9% (n=2,459) at the highest illness severity, all of which had intravenous options, but few of which were Access antibiotics (1.25%, n=33) or had oral options (1.74%, n=46).

## Interpretation

Our utility function could improve individual and population outcomes from antibiotic treatment by leveraging machine learning and prescriber intuition to balance the risk of antibiotic failure against the risk of antibiotic harm. Decision support tools that tailor treatments to diverse individuals and populations should be tested in clinical studies.

## Funding

Funded in part by the Wellcome Trust grant ref: 226691/Z/22/Z. Supported by the Office for Life Sciences Data-Action Accelerator award.

# Introduction

Antimicrobial resistance (AMR) is a significant threat to the delivery of global healthcare.[@walshAntimicrobialResistanceAddressing2023] In September 2024, the United Nations General Assembly (UNGA) committed to ensuring that the safest, cheapest antibiotics with the lowest AMR risk (World Health Organisation \[WHO\] Access Category antibiotics) make up 70% of global antibiotic use in healthcare by 2030.[@un2024_amr] The challenge in achieving this goal is determining when it is safe to empirically use Access agents, which often have a relatively narrow spectrum of activity and will therefore be avoided in favour of more harmful Watch category agents to ensure treatment efficacy. This issue is compounded when there is doubt about the presence of resistance and/or there are significant adverse consequences for incorrect choices (e.g., treatment of systemically unwell patients). [@howardPersonalisedAntimicrobialSusceptibility2024, @rheeTrendsEmpiricBroadSpectrum2024]

Algorithmic support of antimicrobial treatment choice is a potential means to deliver optimally precise antimicrobial therapy - this approach can quantify the probability of resistance and treatment outcomes using clinical prediction models with drug, patient, and pathogen characteristics.[@corbinPersonalizedAntibiogramsMachine2022] Its usefulness supporting holistic prescribing decisions, however, is hampered by the lack of a robust utility function, a mathematical equation to quantify the value of different antibiotic treatment options based on machine learning predictions and intuition derived from domain knowledge/experience.[@staderAlgorithmsDontHave2024,@walshUtilityFunctionsAutonomic2004] Antibiotic treatment suggestions using a utility function might give prescribers the confidence to use Access category antibiotics when it is safe to do so, while compromising on Access antibiotic use in situations where treatment efficacy needs to be prioritised (e.g., where risk of resistance and/or clinical deterioration from untreated infection is high). 

Here, we describe a urinary tract infection (UTI) antibiotic choice automation approach, built on a utility function that combines machine learning prediction of treatment outcomes with prescriber-informed outcome values/costs, and illness severity. The aims of this study are to firstly assess whether UTI treatment recommendations based on the utility function can successfully cover urinary pathogens using at least 70% Access category antibiotics, and secondly to assess whether recommendations adapt appropriately to prioritise organism coverage and intravenous antibiotics as illness severity increases. 

# Methods

## Ethics

The study complied with the PhysioNet MIMIC-IV dataset Data Use Agreement 1.5.0 and Health Data License. Approval was also obtained for a discrete choice experiment (an antibiotic ranking scenario task undertaken by prescribers) from the NHS Health Research Authority (HRA). A review was undertaken by a UK Research Ethics Committee (IRAS 330186), which determined that full ethics committee review was not required.

## Data sources and processing

Clinical prediction model training/testing/validation was performed using antibiotic prescribing and urine culture data from the open-source PhysioNet dataset MIMIC (Medical Information Mart for Intensive Care)-IV version 2.2, a pseudonymised inpatient and outpatient electronic healthcare record dataset for patients over the age of 18 who were admitted to intensive care or the emergency department between 2008 and 2019 at Beth Israel Deaconess Medical Center (BIDMC - Boston, MA) (<https://physionet.org/content/mimiciv/2.2/>).[@johnsonMIMICIVClinicalDatabase, @johnsonMIMICIVFreelyAccessible2023b, @goldbergerPhysioBankPhysioToolkitPhysioNet2000b] The microsimulation study was performed on a holdout dataset of the urine culture data. The full data preprocessing workflow is summarised in Appendix 3. Data preprocessing and quality checking was performed in a similar way across sociodemographic groups using R version 4.3.2 (2023-10-31), and followed an expanded version of the process used in our previous work using logistic regression models to personalise antimicrobial susceptibility testing.[@howardPersonalisedAntimicrobialSusceptibility2024, @rstudioref].

After data preprocessing, prescribing data and urine culture susceptibility data were available for 13 antibiotics (ampicillin, ampicillin-sulbactam, piperacillin-tazobactam, cefazolin, ceftriaxone, cefepime, meropenem, ciprofloxacin, gentamicin, trimethoprim-sulfamethoxazole, nitrofurantoin, and vancomycin). Antimicrobial susceptibility interpretations are likely to be based on Clinical Laboratory Standards Institute clinical breakpoints given the U.S. setting.[@patelUpdatingBreakpointsUnited2023] Sample size was determined by the size of the available datasets, and provided a sufficient number of cases per independent variable in the model to prevent overfitting.[@bramerAvoidingOverfittingDecision2007]

Antibiotic financial cost was determined using the lowest procurement/tender award price for each agent in U.S. dollars as listed on the U.S. Department of Veterans Affairs National Acquisition Center (<https://www.vendorportal.ecms.va.gov/NAC/>) when accessed in November 2024 - these values were divided by the highest cost including combinations of antibiotics to produce normalised numbers between zero and one.[@supportVANationalAcquisition]

The discrete choice experiment provided component weights $w$ for the utility function. The experiment took the form of a survey that was completed online between June 1st 2024 and October 31st 2024 by UK-based antibiotic prescribers from general practice (GP), medicine, surgery, intensive care, and infectious diseases/medical microbiology, contacted through organisational and departmental single points of contact by email. Sample size was determined by the number of respondents in the 4-month survey period. No minimum sample size was prespecified, but the aim was to obtain at least some participants from each specialty.

A questionnaire (see Appendix 1) posed 13 fictional antibiotics with six characteristics (AWaRe class, CDI risk, toxicity, UTI-specificity, oral and IV administration) - these numbers of fictional antibiotics and characteristics were chosen as a balance between the time taken for respondents to complete the task and providing sufficient differences between the antibiotic options to minimise collinearity.[@buddAdaptationWHOEssential2019] Participants were given a fictional UTI clinical scenario, then asked to rank the treatments in order of suitability.

## Utility function design

The utility function is a mathematical calculation that outputs a numerical utility value $U$ for each antibiotic option for each individual patient - this number represents the value of each antibiotic to that patient as a potential treatment. Utility is calculated in a way that is designed to mimic intuitive human decision making by considering the characteristics and possible consequences of antibiotic treatment (component values $v$), the importance of those consequences (component weights $w_k$ and $w_l$), and the consequences of antibiotic failure (a safety mechanism $w_i$)[@zhurisk2021].

Antibiotic treatment choice utility ($U$) is defined by:\

$$
U^{(x)(n)} = v_s^{(x)(n)}\left(  \sum_{k \in K} u\left(w_k, v_k^{(x)}\right) + 
\sum_{l \in L} u\left(w_l, v_l^{(x)(n)}\right) +
u\left(w^{(n)}_i, v_i^{(x)}\right) \right)
$$ {#eq-utility}\
\
where\

$$
u(w, v) = 
\begin{cases}
    wp & \text{if } w \geq 0 \\
    |w|(1-v) & \text{otherwise} \
\end{cases}
$$\
\
$x$ is the antibiotic, $n$ is the patient, $K$ is a set of antibiotic characteristics $\{u, a, o, r, h\}$, $L$ is a set of outcome probabilities $\{c, t\}$, $v$ are component values, and $w$ are component weights.

Component values $v$ represent the characteristics $v_{k}$ and predicted outcomes $v_l$ of the antibiotic option, and are defined as follows:\

$$
v_s \in [0,1] \quad \text{(Probability of covering urine pathogen)}
$$

$$
v_u \in \{0,1\} \quad \text{(UTI-specific agent)}
$$

$$
v_a \in \{0,1\} \quad \text{(WHO Access agent)}
$$

$$
v_o \in \{0,1\} \quad \text{(Orally-administrable agent)}
$$

$$
v_i \in \{0,1\} \quad \text{(Intravenously-administrable agent)}
$$

$$
v_r \in \{0,1\} \quad \text{(WHO Reserve agent)}
$$

$$
v_h \in [0,1] \quad \text{(Normalised agent cost)}
$$

$$
v_c \in [0,1] \quad \text{(Probability of } \textit{Clostridiodes difficile} \text{ infection)}
$$

$$
v_t \in [0,1] \quad \text{(Probability of agent toxicity)}
$$\
\
where probability values $v_s$, $v_c$, and $v_t$ are calculated using XGBoost models trained, tested and validated on MIMIC-IV urine antibiotic susceptibility data (for $v_s$) and antibiotic prescription data (for $v_c$ and $v_t$) as described in Appendix 4.

Component weights $w$ represent the importance of antibiotic characteristics and outcomes. Component weights $w_k$ and $w_l$ are defined solely by their relative contributions to prescriber antibiotic choices (i.e., coefficients) in a logistic regression model trained on antibiotic ranking data from the discrete choice experiment.

$w_i$ is a safety mechanism designed increases the relative importance of coverage the urinary pathogen and intravenous treatment as the potential consequences of antibiotic failure become more severe, and is defined as:\

$$
w_i^{(n)} = w_{i,1}w_{i,2}^{(n)}w_{i,3}
$$\
\
where $w_{i,1}$ is the discrete choice experiment logistic regression coefficient corresponding to intravenous route of administration, $w_{i,2}$ is an illness severity score chosen by the user (e.g., National Early Warning Score \[NEWS\] or the APACHE II score), and $w_{i,3}$ is an adjustment weight to calibrate the mechanism to the chosen severity score. The rationale for this approach is that more systemically unwell patients are more likely to have sepsis, in which scenario the consequences of ineffective antibiotic therapy are more severe.[@buckmanEmpiricAntibioticsSepsis2018] 

\

## Microsimulation study

An individual-level simulation (microsimulation) study design was used to assess distributions of antibiotic utility values and projected outcomes of the decision algorithm in real-world data.[@DynamicMicrosimulationModels] The distributions of utility values at an illness severity value of zero were plotted across the microsimulation dataset for each antibiotic and antibiotic combination using a box and whisker plot.

All 13 antimicrobial agents were ranked according to utility value for each patient to identify personalised treatment recommendations. This process was repeated at a range of 13 illness severity weights ($w_{i,2}$) equally spaced between 0 and 30 inclusive (the upper end of the range was chosen by observing where antibiotic recommendations stopped changing in response to changes in illness severity) with a default adjustment weight ($w_{i,3}$) of 1.

## Outcomes

The outcomes of interest were:

1.  The proportion of urine pathogens covered by WHO Access category, oral, and intravenous simulated utility-based personalised UTI treatment recommendations at the minimum illness severity value (0).

2.  The proportion of urine pathogens covered by WHO Access category, oral, and intravenous simulated utility-based personalised UTI treatment recommendations at the maximum illness severity value (30).

3.  The median and interquartile range of the number of susceptible results in the top six recommendations, compared to a standard top six of nitrofurantoin, trimethoprim/sulfamethoxazole, gentamicin, piperacillin/tazobactam, ceftriaxone, and ciprofloxacin(based on a combination and WHO and European Society of Urology UTI treatment guidelines, as described in our previous work).[@howardPersonalisedAntimicrobialSusceptibility2024, @EAUGuidelinesUrologicala, @WHOAWaReAccess]

## Sensitivity analyses

Sensitivity analyses were performed to assess how utility values and recommendations produced by the utility function changed in response to changes in parameter inputs (including edge cases where parameters had extreme values). Different clinical scenarios were assessed using the microsimulation study design, to observe changes in recommendations and pathogen coverage with second-line treatment recommendations (antibiotics with the second-highest treatment utility), 2-agent antibiotic combinations, improved probability predictions (simulated by taking the mean of the predicted probability and the actual outcome denoted by one or zero), and changing nitrofurantoin resistance rates.

# Results

## Participants

The characteristics of the MIMIC-IV urine culture and prescription datasets used to train clinical prediction models and perform the microsimulation study are summarised in Appendix 5. In the urine culture data, females were more prevalent than males (n=19,010 versus n=7,447), and 70-79 was the most prevalent age group (n=5,079). In the prescriptions dataset, 60-69 year olds were the most prevalent age group (n=17,926). The numbers of different antibiotic types prescribed in the prescription dataset are summarised in Appendix 6.

49 prescribers completed the discrete choice experiment, 47 of whom were based in Liverpool. A total of 15 participants were from infection specialties (medical microbiology and infectious diseases), 11 were from other medical specialties (haematology, respiratory medicine, and acute medicine), nine were from surgical specialties (urology and general surgery), nine were from intensive care, and five were from general practice.

## Clinical prediction models

Final training hyperparameters used for each clinical prediction model are summarised in Appendix 7, and predictor variable contributions to predictive performance are summarised in Appendix 8. The presence and/or absence of previously-detected resistance to an antibiotic in the last year was one of the largest contributors to predictive accuracy for susceptibility to that antibiotic in most models. Gender and age group were large contributors to antibiotic susceptibility predictive performance in all models. Hospital admission in the last year, age over 65, previous CDI, and previous acute kidney injury in the last year were among the largest contributors to predictive performance for both CDI and antibiotic toxicity.

Receiver operating characteristics (ROC) curves and performance metrics for models predicting single-antibiotic susceptibility, *C. difficile* infection (CDI), and toxicity in the single validation run on the validation dataset are summarised in Figure 2 and Table 1 respectively. ROC curves and performance metrics for models predicting susceptibility to 2-antibiotic combinations are summarised in Appendix 9 and Appendix 10 respectively.

```{r, echo=FALSE,message=FALSE,warning=FALSE}

knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/roc_plots_main.pdf")
  
```

Figure 2: ROC curves for probability predictions made for single-antibiotic susceptibility, *C. difficile* infection (CDI), and toxicity on the validation dataset.\

```{r, echo=FALSE,message=FALSE,warning=FALSE}

metrics_singles_table <- read_csv("/Users/alexhoward/Documents/Projects/UDAST_code/metrics_singles_table.csv")

knitr::kable(metrics_singles_table)

```

Table 1: Model performance metrics for prediction of single-antibiotic susceptibility, CDI, and antibiotic toxicity in the single validation run on the validation dataset. 95% confidence intervals are displayed in parentheses.\

Performance metrics from the small training dataset stability analysis are summarised in Appendix 11. The largest difference in mean AUROC across six model train-test iterations was observed between the 2% and 12% training datasets in the CDI prediction model (0.132, 0.631 versus 0.763), and the largest AUROC standard deviation was observed in the 2% dataset in the CDI prediction model (0.025).

Performance metrics from the year group cluster analyses are summarised in Appendix 12. For all models and all year groups, mean AUROC across six train-test iterations was highest in the same year group upon which the model had been trained. The largest difference in AUROC between year groups was observed for the toxicity prediction model between 2011-2013 training, 2011-2013 testing and 2011-2013 training, 2014-2016 testing (0.257, 0.880 versus 0.623). The largest AUROC standard deviation was observed for the CDI model with 2008-2010 training, 2011-2013 testing (0.091).

Performance metrics from the model fairness analyses are summarised in Appendix 13. The largest difference in mean AUROC across six model train-test iterations in the age fairness analysis was observed between the 40-49 and 80-89 age groups for piperacillin-tazobactam susceptibility prediction (0.136, 0.831 versus 0.695), and the largest AUROC standard deviation was observed for CDI prediction in the over 90s age group (0.077). The largest difference in mean AUROC across six model training iterations in the race fairness analysis was observed between Hispanic patients and the aggregate group containing the least prevalent local races (i.e., not Asian, black, or white) for ciprofloxacin prediction (0.093, 0.738 versus 0.646), and the largest AUROC standard deviation was observed in Asian patients for CDI prediction (0.078). The largest difference in mean AUROC across six model training iterations in the remaining characteristics was observed between females and males - this difference was most marked in susceptibility prediction models for cephalosporins, meropenem, and gentamicin, with the largest difference in mean AUROC observed for meropenem (0.102, 0.727 versus 0.625), and the largest AUROC standard deviation observed in piperacillin-tazobactam susceptibility prediction for males (0.023).

## Discrete choice experiment

The coefficients from the ranked logit analysis of the discrete choice experiment across all specialties are displayed in Figure 3, and the coefficients by individual specialty are displayed in Appendix 14. Overall, an antibiotic being specific to urinary tract infection in its licensed indication appeared to have the most positive effect on its probability of selection in the discrete choice experiment, and high toxicity risk the greatest negative effect on its probability of selection. High antibiotic cost appeared to have the least effect on probability of antibiotic selection, exhibiting a minimal positive effect with the approximated 95% confidence interval crossing the line of no effect.

```{r, echo=FALSE,message=FALSE,warning=FALSE}

knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/ORplot.pdf")

```

Figure 3: Coefficients from the ranked logit analysis of the discrete choice experiment across all prescriber specialties.\

General practitioners and infection specialists were more likely to select antibiotics with oral routes of administration, and less likely to select antibiotics with intravenous routes of administration - the opposite was observed in intensive care and medical specialty prescribers, where intravenous routes of administration were preferred over oral routes. Routes of administration appeared to have less bearing on choice in surgical specialties than in other specialties. In medical specialties and intensive care, an antibiotic being in the WHO Access category most increased the probability of selection. Intensive care was the only specialty in which an antibiotic being in the WHO Reserve category reduced the probability of selection more than high toxicity risk. Wide confidence intervals for coefficients estimated from general practitioners reflected the low numbers of respondents from that prescriber group (n=5).

## Microsimulation study

The distributions of single-antimicrobial choice utility values for patients across the microsimulation dataset are displayed in Figure 4, The distributions of single-agent utility values stratified by prescriber types are displayed in Appendix 15, and the distribution of all antibiotic options including 2-agent combinations are displayed in Appendix 16.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/utility_Treatment_ (single agent).pdf")
```

Figure 4: Distributions of antimicrobial choice utility values for patients across the microsimulation dataset.\

At the lowest illness severity (zero), nitrofurantoin had the highest median treatment choice utility in the microsimulation dataset. For single-agent treatment, five of the six antibiotics with the highest median utility were WHO Access agents - the only exception to this was piperacillin-tazobactam, which placed fourth overall amongst single agents. The lowest placed WHO Access antibiotic was ampicillin (or amoxicillin), which placed 12th out of 13 agents. Vancomycin was the lowest-placed antibiotic choice for most patients in terms of median utility across the population. The widest spread in utility values was observed for cefazolin (IQR 1.57), reflecting the fact that predicted probability of susceptibility to cefazolin varied the most across the population (IQR 0.28).

Nitrofurantoin was the highest-placed agent for all prescriber specialties in terms of median utility across the population, and the placement of other agents was more variable. The largest differences observed between antibiotic utility values were between general practice and intensive care – agents with oral routes of administration ranked higher in the former, while those with intravenous routes of administration ranked higher in the latter. When two-agent combinations were included in the general analysis, ampicillin plus gentamicin became the second-placed treatment option in terms of median utility across the population (behind nitrofurantoin), meropenem plus vancomycin the third, and piperacillin-tazobactam plus ciprofloxacin the fourth.

The proportion of urine isolates covered by the first-line recommendations of the utility function algorithm across a range of illness severities are displayed in Figure 5.

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of WHO Access agents)_susplot.pdf")
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of orally-administrable agents)_susplot.pdf")
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/overall _MEWS_according to illness severity (proportion of IV-administrable agents)_susplot.pdf")
```

Figure 5: The proportion of organisms subsequently grown in urines that were covered by the automated first-line antibiotic treatment recommendation depending on illness severity, with the proportion of Access category agents (top), agents with oral routes of administration (middle), and agents with intravenous routes of administration (bottom) providing coverage also indicated. Proportions of coverage of the oral agent with the highest susceptibility rates (nitrofurantoin) and the intravenous agent with the highest susceptibility rates (piperacillin-tazobactam) – are displayed as dotted black lines. The UNGA 70% Access agent target is displayed as a green dotted line on the top plot.\

At the lowest illness severity (zero), nitrofurantoin was the first-line treatment recommendation in almost all cases, covering 81.25% of organisms subsequently grown. As population illness severity was increased, the proportion of organisms covered and the provision of an IV treatment option increased accordingly, both reaching a plateau at 92.94% for the most unwell patients. Likelihood of coverage for a patient population with severe illness was achieved by the algorithm at the expense of recommending Access treatment options and oral treatment options (which fell to 1.25% and 1.75% respectively for the most unwell patients) - this was largely driven by a switch of automated recommendations to piperacillin-tazobactam (Figure 6) as population illness severity was increased. At intermediate levels of illness severity, the proportion of Access agent recommendations was maintained by the algorithm by increasing recommendations for cefazolin or gentamicin. Median predicted CDI probability from automated recommendations remained low as illness severity increased. Median predicted antibiotic toxicity probability from automated recommendations increased from 0.072 to 0.164 as illness severity increased. Median minimum U.S. drug cost increased from \$18.80 to \$22.10 as illness severity increased.\

```{r, echo=FALSE,message=FALSE,warning=FALSE}
knitr::include_graphics("/Users/alexhoward/Documents/Projects/UDAST_code/illness_abplot.pdf")

```

Figure 6: The make-up of automated first-line treatment recommendations by antibiotic agent depending on illness severity.\

The number of susceptible results provided by the top six treatment recommendations from the automated and standard panel are displayed in Appendix 17. At an illness severity of zero, there were a median of five (IQR 4-6) susceptible results per specimen provided by the top six automated recommendations, compared to a median of five (IQR 3-6) susceptible results provided by the standard panel. There were a median of three (IQR 2-4) susceptible results per specimen for WHO Access antibiotics provided by the top six automated recommendations, compared to a median of three (IQR 1-3) susceptible results for WHO Access antibiotics provided by the standard panel.

## Sensitivity analyses

Line plots of the effect of varying different utility function parameters on overall treatment choice utility are displayed in Appendix 18. The largest factor in the sensitivity of antibiotic utility to parameter changes within the utility function was probability of susceptibility, reflecting the fact that they were being multiplied this value in the utility function – the steepest corresponding increases/decreases in utility when most parameters were varied were therefore observed for piperacillin-tazobactam because it had the highest median predicted probability of susceptibility (0.899). When probability of susceptibility or susceptibility prediction AUROC were varied, the combined value of all other parameters in the utility function became more important - nitrofurantoin therefore exhibited the steepest corresponding increases/decreases in utility in response to changes in susceptibility prediction AUROC. There was little variation in utility function sensitivity between antibiotics when CDI importance weight was varied, reflecting low median predicted probabilities of CDI in the dataset (all values for single agents falling between 0.002 for meropenem and 0.001 for cefazolin). There was more variation in utility between antibiotics when toxicity importance was varied, reflecting a wider variation in toxicity probability (all values for single agents falling between 0.190 for meropenem and 0.071 for nitrofurantoin). Varying AUROC values for CDI and toxicity prediction had little effect on overall utility values.

The proportion of organisms covered by second-line automated recommendations (Appendix 19) initially increased with illness severity due to nitrofurantoin falling to second-line option, but as intravenous treatment was prioritised, the proportion of coverage fell back to 80.2%. The proportion of Access category agents with coverage was preserved at 30.2% at high illness severity owing to higher proportions of gentamicin recommendations for second-line treatment than for first-line treatment

When combinations of antimicrobial agents were included (Appendix 20), automated treatment recommendations were able to cover a higher proportion of the most unwell population (98.5%) by recommending either meropenem and vancomycin, piperacillin-tazobactam and ciprofloxacin, or piperacillin-tazobactam and trimethoprim-sulfamethoxazole. At intermediate levels of illness severity, the proportion of Access agent recommendations was maintained by the algorithm by increasing recommendations for ampicillin and gentamicin.

Artificially improving the accuracy of probability predictions (Appendix 21) increased the proportion of organisms covered by first-line treatment recommendations for all levels of illness severity (98.8%), preserving 28.3% Access and 30% oral antibiotic recommendations even at the highest levels of illness severity while increasing the number of recommendations with IV preparations to 98.7%.

Increasing median nitrofurantoin predicted resistance probability (Appendix 22) reduced the proportion of first-line automated recommendation organism coverage to a nadir of 65.5% at a median resistance probability of 43.3%. As nitrofurantoin resistance predictions rose above 50%, the coverage proportion rose to 78.9% as the algorithm selected more gentamicin, ampicillin/sulbactam, and cefazolin as first-line therapy instead of nitrofurantoin.

When extreme discrete choice experiment results were simulated (Appendix 23) oral antibiotics appropriately scored higher and more expensive antibiotics scored lower, with ciprofloxacin exhibiting the highest median utility value. An unanticipated effect was a strongly negative ranked logit coefficient for UTI-specificity, resulting in a low median utility value for nitrofurantoin. To address suspected collinearity as a cause for this phenomenon, UTI-specificity was removed from one antibiotic option with an oral route of administration and added to an antibiotic without an oral route of adminstration – this action resolved the effect and resulted in a positive coefficient value for UTI-specificity (Appendix 24).\

# Discussion

This study shows that antibiotic decision making for individual patients can be made more empirical and systematic by using an algorithmic utility function built on clinical prediction modelling, prescriber discrete choice experiments, and measures of illness severity. This automation could help safely maximise the use of WHO Access category antibiotics in clinical practice while minimising the risk of clinical failure due to resistance. Where illness severity is very low or very high, our algorithm behaves much like a fixed antimicrobial formulary, where patients with uncomplicated lower UTI are recommended nitrofurantoin and patients with urosepsis are recommended piperacillin-tazobactam. However, the algorithm is able to provide more nuance than an antimicrobial formulary in the area in between these two extremes. As illness severity increases, our algorithm progressively compromises on the use of Access agents to reduce the probability of clinical failure and prioritise agents that can be administered intravenously.

Our algorithm can safely navigate antibiotic decision making for three reasons: firstly, clinical prediction modelling is likely to provide more objective estimates of the probability of antibiotic outcomes than clinicians who can be vulnerable to psychological phenomena such as the availability heuristic (where the gravity of events influences perception of their probability); secondly, the algorithm leverages the experience of real-world prescribers by quantifying how important they perceive different factors to be in a theoretical scenario where they can be more objective; and thirdly, the utility function is constructed to weight intravenous antibiotics and probability of susceptibility more heavily as patients become more unwell, allowing the algorithm to replicate a key aspect of clinical judgement in antibiotic prescribing – weighing the risks of untreated infection vs antibiotic-related harms and AMR generation.

We envisage the algorithm result being presented to the clinician at the point of ordering a urine culture test. The utility of different antibiotic options can be calculated using probability predictions based on the patient’s prior healthcare data, importance weights from a local discrete choice experiment, and a locally relevant illness severity score (e.g., National Early Warning Score \[NEWS\] in the UK). The top three antibiotics can then be communicated to the clinician through the test ordering interface as first, second, and third-line recommendations, and the top six antibiotics are chosen for susceptibility testing. For this to be done safely, local calibration of the utility function to the chosen illness severity score will need to be performed with input from expert prescriber stakeholders by tweaking the built-in severity weight and gauging its effect with the sensitivity analysis displayed in Figure 5 – this will ensure that coverage rates are acceptable to local users of the algorithm (e.g., a coverage of at least 90% may be desired once a patient’s NEWS is 5 or above). The algorithm could also be easily adapted to account for known antibiotic allergies and other contraindications when making prescribing recommendations – this is not done in this study because reliable allergy information is not available in the dataset.

Subsetting the discrete choice experiment by specialty highlights that the utility function can and should be adapted for the setting in which it will be used to direct automated prescribing decisions. The experiment reveals, for example, that intensive care physicians have different needs and priorities to general practitioners when presented with the UTI clinical scenario. Cost is not a high priority for any prescribers in this study, but in low and middle income countries (LMICs) this may be given a much higher weight by local prescribers in the discrete choice experiment, and therefore in the automated prescribing decisions it informs. A lack of digital infrastructure in LMICs may provide a barrier to the implementation of personalised algorithmic prescribing decisions, but the utility function approach may also be useful for population-level and policy-level decisions (e.g. informing LMIC formularies or directing antibiotic supply chains).

The microsimulation approach in this study helps gauge the performance of the algorithm in a more meaningful way than metrics such as AUROC alone. The fact that the decision algorithm is unable to provide a higher probability of organism coverage for very unwell patients than piperacillin-tazobactam (the antibiotic in the study with the highest probability of coverage of organisms grown) shows that the algorithm’s susceptibility probability predictions are not able to detect rare resistance with sufficient sensitivity to provide additional benefit over a ‘one-size-fits-all’ approach in the most unwell patients. When probability predictions are artificially improved, the performance of the algorithm also improves in recommending an antibiotic that is more likely to cover the organism grown from patients at all levels of illness severity.

Another benefit of improving predictions could be greater fairness. Our fairness analysis shows that AUROCs are lower for males when predicting susceptibility to several antibiotics. Because a classification approach is not used here, methods to resolve this such as decision threshold modification are not possible – our algorithm instead weights probability predictions by their AUROCs so that agents with higher prediction probability confidence are prioritised. The most effective way to improve fairness, however, would be more data collection from under-represented groups – predictions are likely to be poorer in males because UTI is less common in that cohort, so they are less well-represented in the training dataset. More data collection may also help to improve performance in different and time periods and geographical cohorts – probability predictions in this study are worse when models are trained on one time period and tested on another, reflecting how AMR constantly changes over time.

The algorithm adapts to different resistance rates. When nitrofurantoin resistance probabilities are increased in the sensitivity analysis, the algorithm initially continues to select nitrofurantoin first-line due to the expressed priorities of prescribers in the discrete choice experiment (UTI-specificity, oral administration, and Access category), despite falling probability of organism coverage. The algorithm reaches a tipping point once nitrofurantoin resistance probability hits a particular threshold, other antibiotics are selected first-line, and probability of coverage rises again. This phenomenon demonstrates that despite the utility function being a linear mathematical expression, the effects of changing real-world circumstances on decisions (and therefore potentially patient outcomes) are not necessarily linear. Another example of this is second-line treatment recommendations, where the probability of coverage rises and falls with increasing illness severity as nitrofurantoin temporarily becomes the second-line agent as it falls down the utility rankings.

An assumption made in the main analyses of this study is that a single antibiotic is preferable as empirical treatment. It is possible, however, that as AMR increases globally, combination regimens may become increasingly desirable and/or necessary – this is already reflected in some treatment guidelines, particularly where allergies and other drug contraindications make achieving adequate empirical coverage with a single antibiotic difficult. In this study, the decision algorithm is able to achieve higher rates of coverage than universal piperacillin-tazobactam treatment once combinations of agents are included. Predicting outcomes from antibiotic combinations using retrospective real-world data is challenging, due to its relative rarity in many settings - the benefit of using an adaptive approach with up-to-date real-world data, however, is that algorithmic decisions should further improve if combination therapy becomes more common.

When confronted with an extreme scenario (an ‘edge case’) where 1,000 sets of discrete choice experiment rankings were identical and all favoured oral administration options, the utility function responds appropriately by prioritising oral antibiotics at the expense of all other considerations but unexpectedly deprioritises UTI-specificity. The probable reason for this phenomenon is that all options in the discrete choice experiment that were UTI-specific also had oral options, resulting in strong collinearity in the model. When this collinearity was reduced by retrospectively changing the characteristics of two antibiotic options, the UTI-specificity coefficient was more as expected. In future work, an expanded panel of antibiotic options should be considered to enable more variation in characteristics to reduce collinearity – however, a strength of our survey was its brevity, so any expansion should be balanced against the effect of time taken to complete the survey on anticipated response rates.

Our study has several limitations: firstly, the urine dataset is limited to secondary care patients and the prescription dataset to inpatients only. Given that the benefits of the algorithm are likely to be highest in primary care where most antibiotic prescribing occurs, the approach needs to be validated in this setting. Secondly, although the microsimulation approach can indicate how recommendations would have covered organisms grown here, it cannot determine whether recommendations would have been followed, or examine potential outcomes in instances of UTI where organisms are not grown. The algorithm therefore needs to be validated in a clinical study with appropriate outcomes that incorporate health economic analyses to best ascertain overall patient and population impact. Thirdly, the number of respondents to the discrete choice experiment is the lowest in the general practitioner group, which may reflect that this cohort are among the busiest and therefore do not have time to undertake a survey. Paradoxically, it is these specialty cohorts in which a decision support algorithm may have the most benefit, so further work is required to understand how best to engage busy clinicians in qualitative-quantitative study approaches.

Despite these limitations, this study demonstrates how an innovative algorithmic decision approach that constructs a utility function from quantification of the key considerations for antimicrobial prescribing decisions (namely probability of different outcomes, the importance of different outcomes, and the consequences of inaccurate predictions) could help countries achieve the WHO target of 70% Access category antibiotic prescribing by 2030 in a way that does not endanger clinical efficacy where it matters most - in severely ill patients at high risk of deterioration from sepsis. Further research is required in a clinical study across multiple geographical areas to better understand the impact of our automated decision algorithm on individual and population outcomes.

# References

::: {#refs}
:::

## Funding

This research was funded in part by the Wellcome Trust grant ref: 226691/Z/22/Z. For the purpose of open access, the author has applied a CC BY public copyright licence to any Author Accepted Manuscript version arising from this submission. Office for Life Sciences Data-Action Accelerator award also supported this work. The funders had no role in the conceptualisation, design, data collection, analysis, decision to publish or preparation of the manuscript.

## Conflicts of interest

Alex Howard declares personal consulting work for Pfizer outside the submitted work, and a donation from Pfizer to the University of Liverpool for a public and professional engagement project outside the submitted work.

## Data sharing

The MIMIC-IV version 2.2 data set is publicly accessible as a credentialed PhysioNet user at https://physionet.org/content/mimiciv/2.2/ once mandated training is completed, and the data use agreement is signed. Additional aggregate-level data can be provided by the authors if requests to do so are in line with legal and ethical data use regulations. Open-source code written for this study will be made available upon publication.

## Code sharing

Open-source code to reproduce the study using the above dataset is available at <https://github.com/amh312/Antimicrobial_utility>.

## Contributions

AH conceived the study, performed data engineering and mathematical modelling, and wrote the manuscript including diagrams.

## Acknowledgements

**Permissions from survey participants required**
